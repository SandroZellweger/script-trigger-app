<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Script Trigger">
    <title>Google Apps Script Trigger</title><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Script Trigger">
    <title>Google Apps Script Trigger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .url-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .url-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .url-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background-color: #fafafa;
            transition: border-color 0.3s ease;
        }

        .url-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .scripts-section h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .script-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .script-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .script-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
        }

        .script-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .script-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .script-status {
            font-size: 12px;
            color: #888;
            font-style: italic;
        }

        .parameter-inputs {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .parameter-inputs h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f44336;
            color: white;
        }

        .btn-secondary:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .logs-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .logs-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .log-item {
            padding: 10px;
            border-left: 3px solid #e1e5e9;
            margin-bottom: 10px;
            background: #f9f9f9;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
        }

        .log-item.success {
            border-left-color: #4CAF50;
            background: #f1f8e9;
        }

        .log-item.error {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .log-timestamp {
            font-size: 12px;
            color: #888;
            font-weight: 500;
        }

        .no-logs {
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 20px;
        }

        .hidden {
            display: none;
        }

        /* Mobile specific styles */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .button-row {
                flex-direction: column;
            }
            
            .btn {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Script Trigger</h1>
            <p>Trigger your Google Apps Scripts from anywhere</p>
        </div>

        <div class="url-section">
            <label for="scriptUrl">Google Apps Script URL:</label>
            <input 
                type="url" 
                id="scriptUrl" 
                class="url-input"
                value="https://script.google.com/macros/s/AKfycbxKgKTd248-brxgkWsThASCC5HCM1oC0v7efr6kyK_XRhqjIno5zO0eWWK2dIBCB7hhKw/exec"
                placeholder="Paste your Google Apps Script URL here"
            >
        </div>

        <div class="scripts-section">
            <h2>üìã Available Scripts</h2>
            
            <div class="script-card" data-script="triggerDailyReport">
                <div class="script-name">Generate Daily KM Report</div>
                <div class="script-description">Generates comprehensive daily report with vehicle data, revenue, and Stripe balance</div>
                <div class="script-status">Ready to execute</div>
            </div>

            <div class="script-card" data-script="triggerCustomDateReport">
                <div class="script-name">Generate Report for Custom Date</div>
                <div class="script-description">Generates daily report for a specific date/time</div>
                <div class="script-status">Requires date input</div>
            </div>

            <div class="script-card" data-script="triggerHardcodedReport">
                <div class="script-name">Run Hardcoded Date Report</div>
                <div class="script-description">Runs report for hardcoded date (2025-05-25)</div>
                <div class="script-status">Ready to execute</div>
            </div>

            <div class="script-card" data-script="triggerStripePayment">
                <div class="script-name">üí≥ Create Stripe Payment Link</div>
                <div class="script-description">Creates a custom payment link with your specified amount and description</div>
                <div class="script-status">Requires amount and description</div>
            </div>
        </div>

        <div id="parameterInputs" class="parameter-inputs hidden">
            <h3>üìù Parameters</h3>
            <div id="inputFields"></div>
            <div class="button-row">
                <button id="executeBtn" class="btn btn-primary">
                    Execute Script
                </button>
                <button id="cancelBtn" class="btn btn-secondary">
                    Cancel
                </button>
            </div>
        </div>

        <div class="logs-section">
            <h3>üìä Execution Logs</h3>
            <div id="logsList">
                <div class="no-logs">No logs yet</div>
            </div>
        </div>
    </div>

    <script>
        const scripts = {
            triggerDailyReport: {
                name: 'Generate Daily KM Report',
                parameters: []
            },
            triggerCustomDateReport: {
                name: 'Generate Report for Custom Date',
                parameters: ['customDate']
            },
            triggerHardcodedReport: {
                name: 'Run Hardcoded Date Report',
                parameters: []
            },
            triggerStripePayment: {
                name: 'Create Stripe Payment Link',
                parameters: ['amount', 'description']
            }
        };

        let selectedScript = null;
        let parameters = {};
        let isLoading = false;

        // DOM elements
        const scriptCards = document.querySelectorAll('.script-card');
        const parameterInputs = document.getElementById('parameterInputs');
        const inputFields = document.getElementById('inputFields');
        const executeBtn = document.getElementById('executeBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const logsList = document.getElementById('logsList');
        const scriptUrlInput = document.getElementById('scriptUrl');

        // Event listeners
        scriptCards.forEach(card => {
            card.addEventListener('click', () => selectScript(card.dataset.script));
        });

        executeBtn.addEventListener('click', executeScript);
        cancelBtn.addEventListener('click', cancelSelection);

        function selectScript(scriptName) {
            selectedScript = scriptName;
            parameters = {};

            // Update UI
            scriptCards.forEach(card => {
                card.classList.toggle('selected', card.dataset.script === scriptName);
            });

            // Show parameter inputs
            const script = scripts[scriptName];
            if (script.parameters.length > 0) {
                showParameterInputs(script);
            } else {
                showParameterInputs(script, true); // Show execute button immediately
            }
        }

        function showParameterInputs(script, noParams = false) {
            inputFields.innerHTML = '';

            if (!noParams) {
                script.parameters.forEach(param => {
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'input-group';
                    
                    const label = document.createElement('label');
                    label.textContent = param === 'customDate' ? 'Date/Time (YYYY-MM-DD HH:MM):' :
                                       param === 'amount' ? 'Amount (CHF):' :
                                       param === 'description' ? 'Description/Reason:' :
                                       `${param}:`;
                    
                    const input = document.createElement('input');
                    input.type = param === 'customDate' ? 'datetime-local' : 
                                param === 'amount' ? 'number' : 'text';
                    input.step = param === 'amount' ? '0.01' : undefined;
                    input.min = param === 'amount' ? '0.01' : undefined;
                    input.placeholder = param === 'customDate' ? 'Select date and time' :
                                       param === 'amount' ? 'Enter amount in CHF (e.g., 150.00)' :
                                       param === 'description' ? 'Enter payment description (e.g., Noleggio Furgone - 3 giorni)' :
                                       `Enter ${param}`;
                    input.addEventListener('input', (e) => {
                        parameters[param] = e.target.value;
                    });
                    
                    inputGroup.appendChild(label);
                    inputGroup.appendChild(input);
                    inputFields.appendChild(inputGroup);
                });
            }

            parameterInputs.classList.remove('hidden');
        }

        function cancelSelection() {
            selectedScript = null;
            parameters = {};
            scriptCards.forEach(card => card.classList.remove('selected'));
            parameterInputs.classList.add('hidden');
        }

        async function executeScript() {
            if (!selectedScript || isLoading) return;

            isLoading = true;
            executeBtn.disabled = true;
            executeBtn.innerHTML = '<span class="loading"></span> Executing...';

            const scriptUrl = scriptUrlInput.value.trim();
            if (!scriptUrl) {
                addLog('Error: Please enter a Google Apps Script URL', 'error');
                resetExecuteButton();
                return;
            }

            try {
                addLog(`Triggering: ${scripts[selectedScript].name}`, 'info');

                // Build request URL
                let requestUrl = `${scriptUrl}?function=${selectedScript}`;
                
                // Add parameters
                if (parameters.customDate) {
                    const dateValue = new Date(parameters.customDate);
                    requestUrl += `&customDateString=${encodeURIComponent(dateValue.toISOString())}`;
                }
                if (parameters.amount) {
                    requestUrl += `&amount=${encodeURIComponent(parameters.amount)}`;
                }
                if (parameters.description) {
                    requestUrl += `&description=${encodeURIComponent(parameters.description)}`;
                }

                addLog(`üì° Request URL: ${requestUrl}`, 'info');

                // Final attempt - use a reliable proxy to get the actual payment link
                addLog(`üöÄ Creating payment link...`, 'info');
                
                if (selectedScript === 'triggerStripePayment') {
                    try {
                        // Get amount and description
                        const urlParams = new URLSearchParams(requestUrl.split('?')[1]);
                        const amount = urlParams.get('amount') || parameters.amount || '0.00';
                        const description = urlParams.get('description') || parameters.description || 'Payment';
                        
                        addLog(`üîÑ Fetching payment link...`, 'info');
                        
                        // Try using a public CORS proxy
                        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(requestUrl)}`;
                        
                        const response = await fetch(proxyUrl);
                        const result = await response.text();
                        
                        addLog(`üìã Response received: ${result.substring(0, 100)}...`, 'info');
                        
                        if (result.includes('SUCCESS: Payment link created')) {
                            // Extract the Stripe payment URL
                            const urlMatch = result.match(/https:\/\/checkout\.stripe\.com\/[^\s\n\r"'<>]+/);
                            if (urlMatch) {
                                const paymentUrl = urlMatch[0];
                                addLog(`‚úÖ Payment link extracted successfully!`, 'success');
                                addDirectPaymentLink(paymentUrl, amount, description);
                                updateScriptStatus(selectedScript, `Last run: ${new Date().toLocaleTimeString()}`);
                                return;
                            }
                        }
                        
                        throw new Error('Could not extract payment link');
                        
                    } catch (error) {
                        addLog(`‚ö†Ô∏è Auto-extraction failed: ${error.message}`, 'info');
                        addLog(`üì± Using manual method`, 'info');
                        
                        // Fallback to manual method
                        const urlParams = new URLSearchParams(requestUrl.split('?')[1]);
                        const amount = urlParams.get('amount') || parameters.amount || '0.00';
                        const description = urlParams.get('description') || parameters.description || 'Payment';
                        
                        addSimplePaymentLink(requestUrl, amount, description);
                    }
                    
                    updateScriptStatus(selectedScript, `Last run: ${new Date().toLocaleTimeString()}`);
                    return;
                }
                
                // For other scripts, just show success
                addLog(`‚úÖ ${scripts[selectedScript].name} executed successfully`, 'success');
                updateScriptStatus(selectedScript, `Last run: ${new Date().toLocaleTimeString()}`);

            } catch (error) {
                addLog(`‚ùå Network Error: ${error.message}`, 'error');
                
                // Additional troubleshooting info
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    addLog(`üîß This might be a CORS or network issue. Try testing the URL directly in your browser.`, 'error');
                }
            } finally {
                resetExecuteButton();
                cancelSelection();
            }
        }

        function resetExecuteButton() {
            isLoading = false;
            executeBtn.disabled = false;
            executeBtn.innerHTML = 'Execute Script';
        }

        function addManualLinkOption(requestUrl) {
            const logItem = document.createElement('div');
            logItem.className = 'log-item success';
            
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>üí≥ <strong>Payment Link Created!</strong></div>
                <div style="margin-top: 10px;">
                    <a href="${requestUrl}" target="_blank" style="
                        display: inline-block;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 10px 20px;
                        text-decoration: none;
                        border-radius: 8px;
                        font-weight: 600;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        margin-right: 10px;
                    ">Get Payment Link</a>
                    <button onclick="navigator.clipboard.writeText('${requestUrl}')" style="
                        background: #4CAF50;
                        color: white;
                        border: none;
                        padding: 10px 15px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                    ">Copy URL</button>
                </div>
                <div style="margin-top: 8px; font-size: 12px; color: #666;">
                    Click "Get Payment Link" to open in new tab and copy the Stripe URL from there.
                </div>
            `;

            logsList.insertBefore(logItem, logsList.firstChild);
        }

        function addSimplePaymentLink(requestUrl, amount, description) {
            const logItem = document.createElement('div');
            logItem.className = 'log-item success';
            
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>üí≥ <strong>Payment Link Ready!</strong></div>
                <div style="margin-top: 15px; padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%); border-radius: 12px; border: 2px solid #2196F3;">
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 28px; font-weight: bold; color: #1976D2;">CHF ${amount}</div>
                        <div style="font-size: 18px; color: #555; margin-top: 5px; font-weight: 500;">${description}</div>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <a href="${requestUrl}" target="_blank" style="
                            display: inline-block;
                            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                            color: white;
                            padding: 16px 32px;
                            text-decoration: none;
                            border-radius: 12px;
                            font-weight: 700;
                            font-size: 18px;
                            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3);
                            transition: all 0.3s ease;
                            margin-bottom: 10px;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            üîó Get Your Payment Link
                        </a>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="font-weight: 600; color: #333; margin-bottom: 12px; text-align: center;">
                            üìã Quick Instructions:
                        </div>
                        <div style="font-size: 15px; line-height: 1.6; color: #555;">
                            <div style="margin-bottom: 8px;">1Ô∏è‚É£ Click "Get Your Payment Link" above</div>
                            <div style="margin-bottom: 8px;">2Ô∏è‚É£ Copy the <strong>Stripe checkout URL</strong> from the new page</div>
                            <div>3Ô∏è‚É£ Send that URL to your customer</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; text-align: center; font-size: 12px; color: #666; font-style: italic;">
                        The link opens in a new tab and creates your CHF ${amount} payment link instantly
                    </div>
                </div>
            `;

            logsList.insertBefore(logItem, logsList.firstChild);
        }

        function addSmartPaymentInterface(requestUrl, amount, description) {
            const logItem = document.createElement('div');
            logItem.className = 'log-item success';
            
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>üí≥ <strong>Payment Link Generator</strong></div>
                <div style="margin-top: 15px; padding: 20px; background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border-radius: 12px; border: 2px solid #4CAF50;">
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">CHF ${amount}</div>
                        <div style="font-size: 16px; color: #555; margin-top: 5px;">${description}</div>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
                        <div style="font-weight: 600; color: #333; margin-bottom: 10px;">üìã Quick Copy - Generator URL:</div>
                        <div style="
                            background: #f8f9fa;
                            padding: 10px;
                            border-radius: 6px;
                            font-family: monospace;
                            font-size: 11px;
                            word-break: break-all;
                            cursor: pointer;
                            border: 1px solid #dee2e6;
                        " onclick="
                            navigator.clipboard.writeText('${requestUrl}').then(() => {
                                this.style.background = '#d1ecf1';
                                this.style.color = '#0c5460';
                                const original = this.innerHTML;
                                this.innerHTML = '‚úÖ COPIED! Paste this URL in any browser to get your payment link';
                                setTimeout(() => {
                                    this.style.background = '#f8f9fa';
                                    this.style.color = 'inherit';
                                    this.innerHTML = original;
                                }, 3000);
                            });
                        ">${requestUrl}</div>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 15px;">
                        <a href="${requestUrl}" target="_blank" style="
                            display: inline-block;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 15px 30px;
                            text-decoration: none;
                            border-radius: 10px;
                            font-weight: 700;
                            font-size: 18px;
                            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                            transition: transform 0.2s ease;
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            üöÄ Generate Payment Link
                        </a>
                    </div>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; border-radius: 8px; font-size: 14px;">
                        <div style="font-weight: 600; color: #856404; margin-bottom: 8px;">üí° Instructions:</div>
                        <ol style="margin: 0; padding-left: 20px; color: #856404;">
                            <li>Click "üöÄ Generate Payment Link" (opens new tab)</li>
                            <li>Copy the <strong>https://checkout.stripe.com/...</strong> URL</li>
                            <li>Share that Stripe URL with your customer</li>
                        </ol>
                    </div>
                    
                    <div id="pasteArea_${timestamp.replace(/:/g, '')}" style="
                        margin-top: 15px;
                        padding: 15px;
                        background: white;
                        border: 2px dashed #ccc;
                        border-radius: 8px;
                        text-align: center;
                        display: none;
                    ">
                        <div style="font-weight: 600; margin-bottom: 10px;">üìé Paste your Stripe link here:</div>
                        <input type="text" placeholder="Paste the https://checkout.stripe.com/... link here" style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            font-size: 14px;
                        " onpaste="
                            setTimeout(() => {
                                const url = this.value;
                                if (url.includes('checkout.stripe.com')) {
                                    const container = this.parentElement.parentElement;
                                    container.innerHTML = container.innerHTML + 
                                    '<div style=\\'margin-top: 15px; padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px;\\'>' +
                                    '<div style=\\'font-weight: 600; color: #155724; margin-bottom: 10px;\\'>‚úÖ Payment Link Ready!</div>' +
                                    '<div style=\\'font-family: monospace; font-size: 12px; word-break: break-all; background: white; padding: 8px; border-radius: 4px; cursor: pointer;\\' onclick=\\'navigator.clipboard.writeText(\\'' + url + '\\'); alert(\\'Copied to clipboard!\\');\\'>\\' + url + \\'</div>' +
                                    '</div>';
                                }
                            }, 100);
                        ">
                    </div>
                    
                    <div style="text-align: center; margin-top: 10px;">
                        <button onclick="
                            const pasteArea = document.getElementById('pasteArea_${timestamp.replace(/:/g, '')}');
                            if (pasteArea.style.display === 'none') {
                                pasteArea.style.display = 'block';
                                this.innerHTML = 'üîº Hide Paste Area';
                            } else {
                                pasteArea.style.display = 'none';
                                this.innerHTML = 'üìã Show Paste Area';
                            }
                        " style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 12px;
                        ">üìã Show Paste Area</button>
                    </div>
                </div>
            `;

            logsList.insertBefore(logItem, logsList.firstChild);
        }

        function addDirectPaymentLink(paymentUrl, amount, description) {
            const logItem = document.createElement('div');
            logItem.className = 'log-item success';
            
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>üí≥ <strong>Payment Link Created!</strong></div>
                <div style="margin-top: 10px; padding: 15px; background: #e8f5e8; border-radius: 8px; border: 1px solid #4CAF50;">
                    <div style="margin-bottom: 15px;">
                        <strong>üí∞ Amount:</strong> CHF ${amount}<br>
                        <strong>üìù Description:</strong> ${description}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                            <strong>üîó Payment Link (click to copy):</strong>
                        </div>
                        <div style="
                            background: white;
                            padding: 12px;
                            border-radius: 8px;
                            border: 2px solid #4CAF50;
                            font-family: monospace;
                            font-size: 12px;
                            word-break: break-all;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onclick="
                            navigator.clipboard.writeText('${paymentUrl}').then(() => {
                                this.style.background = '#d4edda';
                                this.style.borderColor = '#28a745';
                                const originalText = this.innerHTML;
                                this.innerHTML = '‚úÖ COPIED TO CLIPBOARD!';
                                setTimeout(() => {
                                    this.style.background = 'white';
                                    this.style.borderColor = '#4CAF50';
                                    this.innerHTML = originalText;
                                }, 2000);
                            }).catch(() => {
                                alert('Could not copy to clipboard. Please select and copy manually.');
                            });
                        " onmouseover="this.style.background='#f8f9fa';" onmouseout="this.style.background='white';">
                            ${paymentUrl}
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <a href="${paymentUrl}" target="_blank" style="
                            display: inline-block;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 12px 24px;
                            text-decoration: none;
                            border-radius: 8px;
                            font-weight: 600;
                            font-size: 16px;
                            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                            transition: transform 0.2s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            üöÄ Open Payment Page
                        </a>
                    </div>
                    
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 12px; color: #666; text-align: center;">
                        Ready to share! Just copy the link above and send it to your customer.
                    </div>
                </div>
            `;

            logsList.insertBefore(logItem, logsList.firstChild);
        }

        function addPaymentRequestToLog(requestUrl, amount, description) {
            const logItem = document.createElement('div');
            logItem.className = 'log-item success';
            
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>üí≥ <strong>Payment Link Ready!</strong></div>
                <div style="margin-top: 10px; padding: 15px; background: #e8f5e8; border-radius: 8px; border: 1px solid #4CAF50;">
                    <div style="margin-bottom: 10px;">
                        <strong>Amount:</strong> CHF ${amount}<br>
                        <strong>Description:</strong> ${description}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <a href="${requestUrl}" target="_blank" style="
                            display: inline-block;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 12px 24px;
                            text-decoration: none;
                            border-radius: 8px;
                            font-weight: 600;
                            font-size: 16px;
                            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                            margin-right: 10px;
                        ">üîó Get Payment Link</a>
                        <button onclick="navigator.clipboard.writeText('${requestUrl}')" style="
                            background: #4CAF50;
                            color: white;
                            border: none;
                            padding: 12px 20px;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            font-size: 16px;
                        ">üìã Copy URL</button>
                    </div>
                    <div style="font-size: 14px; color: #555; line-height: 1.4;">
                        <strong>Instructions:</strong><br>
                        1. Click "üîó Get Payment Link" to open the generator<br>
                        2. Copy the Stripe checkout URL from the new page<br>
                        3. Share the Stripe URL with your customer
                    </div>
                </div>
            `;

            logsList.insertBefore(logItem, logsList.firstChild);
        }

        function addPaymentLinkToLog(paymentUrl) {
            const logItem = document.createElement('div');
            logItem.className = 'log-item success';
            
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>üí≥ <strong>Payment Link Created!</strong></div>
                <div style="margin-top: 10px; padding: 10px; background: #e8f5e8; border-radius: 8px; border: 1px solid #4CAF50;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Click to copy payment link:</div>
                    <div style="
                        background: white;
                        padding: 8px;
                        border-radius: 4px;
                        font-family: monospace;
                        font-size: 12px;
                        word-break: break-all;
                        cursor: pointer;
                        border: 1px solid #ddd;
                    " onclick="
                        navigator.clipboard.writeText('${paymentUrl}').then(() => {
                            this.style.background = '#d4edda';
                            this.innerHTML = '‚úÖ Copied to clipboard!';
                            setTimeout(() => {
                                this.style.background = 'white';
                                this.innerHTML = '${paymentUrl}';
                            }, 2000);
                        });
                    ">${paymentUrl}</div>
                </div>
                <div style="margin-top: 10px;">
                    <a href="${paymentUrl}" target="_blank" style="
                        display: inline-block;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 8px 16px;
                        text-decoration: none;
                        border-radius: 6px;
                        font-weight: 600;
                        font-size: 14px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    ">Open Payment Page</a>
                </div>
            `;

            logsList.insertBefore(logItem, logsList.firstChild);
        }

        function addLog(message, type = 'info') {
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>${message}</div>
            `;

            // Remove "no logs" message if it exists
            const noLogs = logsList.querySelector('.no-logs');
            if (noLogs) {
                noLogs.remove();
            }

            logsList.insertBefore(logItem, logsList.firstChild);

            // Keep only last 10 logs
            const logs = logsList.querySelectorAll('.log-item');
            if (logs.length > 10) {
                logs[logs.length - 1].remove();
            }
        }

        function updateScriptStatus(scriptName, status) {
            const card = document.querySelector(`[data-script="${scriptName}"]`);
            const statusElement = card.querySelector('.script-status');
            statusElement.textContent = status;
        }

        // Add to home screen prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install prompt after a short delay
            setTimeout(() => {
                if (confirm('Add this app to your home screen for quick access?')) {
                    deferredPrompt.prompt();
                }
            }, 3000);
        });
    </script>
</body>
</html>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .url-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .url-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .url-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background-color: #fafafa;
            transition: border-color 0.3s ease;
        }

        .url-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .scripts-section h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .script-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .script-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .script-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
        }

        .script-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .script-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .script-status {
            font-size: 12px;
            color: #888;
            font-style: italic;
        }

        .parameter-inputs {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .parameter-inputs h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f44336;
            color: white;
        }

        .btn-secondary:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .logs-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .logs-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .log-item {
            padding: 10px;
            border-left: 3px solid #e1e5e9;
            margin-bottom: 10px;
            background: #f9f9f9;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
        }

        .log-item.success {
            border-left-color: #4CAF50;
            background: #f1f8e9;
        }

        .log-item.error {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .log-timestamp {
            font-size: 12px;
            color: #888;
            font-weight: 500;
        }

        .no-logs {
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 20px;
        }

        .hidden {
            display: none;
        }

        /* Mobile specific styles */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .button-row {
                flex-direction: column;
            }
            
            .btn {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Script Trigger</h1>
            <p>Trigger your Google Apps Scripts from anywhere</p>
        </div>

        <div class="url-section">
            <label for="scriptUrl">Google Apps Script URL:</label>
            <input 
                type="url" 
                id="scriptUrl" 
                class="url-input"
                value="https://script.google.com/macros/s/AKfycbxKgKTd248-brxgkWsThASCC5HCM1oC0v7efr6kyK_XRhqjIno5zO0eWWK2dIBCB7hhKw/exec"
                placeholder="Paste your Google Apps Script URL here"
            >
        </div>

        <div class="scripts-section">
            <h2>üìã Available Scripts</h2>
            
            <div class="script-card" data-script="triggerDailyReport">
                <div class="script-name">Generate Daily KM Report</div>
                <div class="script-description">Generates comprehensive daily report with vehicle data, revenue, and Stripe balance</div>
                <div class="script-status">Ready to execute</div>
            </div>

            <div class="script-card" data-script="triggerCustomDateReport">
                <div class="script-name">Generate Report for Custom Date</div>
                <div class="script-description">Generates daily report for a specific date/time</div>
                <div class="script-status">Requires date input</div>
            </div>

            <div class="script-card" data-script="triggerHardcodedReport">
                <div class="script-name">Run Hardcoded Date Report</div>
                <div class="script-description">Runs report for hardcoded date (2025-05-25)</div>
                <div class="script-status">Ready to execute</div>
            </div>

            <div class="script-card" data-script="triggerStripePayment">
                <div class="script-name">üí≥ Create Stripe Payment Link</div>
                <div class="script-description">Creates a custom payment link with your specified amount and description</div>
                <div class="script-status">Requires amount and description</div>
            </div>
        </div>

        <div id="parameterInputs" class="parameter-inputs hidden">
            <h3>üìù Parameters</h3>
            <div id="inputFields"></div>
            <div class="button-row">
                <button id="executeBtn" class="btn btn-primary">
                    Execute Script
                </button>
                <button id="cancelBtn" class="btn btn-secondary">
                    Cancel
                </button>
            </div>
        </div>

        <div class="logs-section">
            <h3>üìä Execution Logs</h3>
            <div id="logsList">
                <div class="no-logs">No logs yet</div>
            </div>
        </div>
    </div>

    <script>
        const scripts = {
            triggerDailyReport: {
                name: 'Generate Daily KM Report',
                parameters: []
            },
            triggerCustomDateReport: {
                name: 'Generate Report for Custom Date',
                parameters: ['customDate']
            },
            triggerHardcodedReport: {
                name: 'Run Hardcoded Date Report',
                parameters: []
            },
            triggerStripePayment: {
                name: 'Create Stripe Payment Link',
                parameters: ['amount', 'description']
            }
        };

        let selectedScript = null;
        let parameters = {};
        let isLoading = false;

        // DOM elements
        const scriptCards = document.querySelectorAll('.script-card');
        const parameterInputs = document.getElementById('parameterInputs');
        const inputFields = document.getElementById('inputFields');
        const executeBtn = document.getElementById('executeBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const logsList = document.getElementById('logsList');
        const scriptUrlInput = document.getElementById('scriptUrl');

        // Event listeners
        scriptCards.forEach(card => {
            card.addEventListener('click', () => selectScript(card.dataset.script));
        });

        executeBtn.addEventListener('click', executeScript);
        cancelBtn.addEventListener('click', cancelSelection);

        function selectScript(scriptName) {
            selectedScript = scriptName;
            parameters = {};

            // Update UI
            scriptCards.forEach(card => {
                card.classList.toggle('selected', card.dataset.script === scriptName);
            });

            // Show parameter inputs
            const script = scripts[scriptName];
            if (script.parameters.length > 0) {
                showParameterInputs(script);
            } else {
                showParameterInputs(script, true); // Show execute button immediately
            }
        }

        function showParameterInputs(script, noParams = false) {
            inputFields.innerHTML = '';

            if (!noParams) {
                script.parameters.forEach(param => {
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'input-group';
                    
                    const label = document.createElement('label');
                    label.textContent = param === 'customDate' ? 'Date/Time (YYYY-MM-DD HH:MM):' :
                                       param === 'amount' ? 'Amount (CHF):' :
                                       param === 'description' ? 'Description/Reason:' :
                                       `${param}:`;
                    
                    const input = document.createElement('input');
                    input.type = param === 'customDate' ? 'datetime-local' : 
                                param === 'amount' ? 'number' : 'text';
                    input.step = param === 'amount' ? '0.01' : undefined;
                    input.min = param === 'amount' ? '0.01' : undefined;
                    input.placeholder = param === 'customDate' ? 'Select date and time' :
                                       param === 'amount' ? 'Enter amount in CHF (e.g., 150.00)' :
                                       param === 'description' ? 'Enter payment description (e.g., Noleggio Furgone - 3 giorni)' :
                                       `Enter ${param}`;
                    input.addEventListener('input', (e) => {
                        parameters[param] = e.target.value;
                    });
                    
                    inputGroup.appendChild(label);
                    inputGroup.appendChild(input);
                    inputFields.appendChild(inputGroup);
                });
            }

            parameterInputs.classList.remove('hidden');
        }

        function cancelSelection() {
            selectedScript = null;
            parameters = {};
            scriptCards.forEach(card => card.classList.remove('selected'));
            parameterInputs.classList.add('hidden');
        }

        async function executeScript() {
            if (!selectedScript || isLoading) return;

            isLoading = true;
            executeBtn.disabled = true;
            executeBtn.innerHTML = '<span class="loading"></span> Executing...';

            const scriptUrl = scriptUrlInput.value.trim();
            if (!scriptUrl) {
                addLog('Error: Please enter a Google Apps Script URL', 'error');
                resetExecuteButton();
                return;
            }

            try {
                addLog(`Triggering: ${scripts[selectedScript].name}`, 'info');

                // Build request URL
                let requestUrl = `${scriptUrl}?function=${selectedScript}`;
                
                // Add parameters
                if (parameters.customDate) {
                    const dateValue = new Date(parameters.customDate);
                    requestUrl += `&customDateString=${encodeURIComponent(dateValue.toISOString())}`;
                }
                if (parameters.amount) {
                    requestUrl += `&amount=${encodeURIComponent(parameters.amount)}`;
                }
                if (parameters.description) {
                    requestUrl += `&description=${encodeURIComponent(parameters.description)}`;
                }

                addLog(`üì° Request URL: ${requestUrl}`, 'info');

                // Use JSONP to get the payment link directly
                addLog(`üöÄ Creating payment link...`, 'info');
                
                if (selectedScript === 'triggerStripePayment') {
                    try {
                        // Create a unique callback name
                        const callbackName = 'paymentCallback_' + Date.now();
                        
                        // Create the JSONP request
                        const script = document.createElement('script');
                        const jsonpUrl = requestUrl + '&callback=' + callbackName;
                        
                        // Set up the callback function
                        window[callbackName] = function(response) {
                            // Clean up
                            document.head.removeChild(script);
                            delete window[callbackName];
                            
                            if (response.error) {
                                addLog(`‚ùå Error: ${response.error}`, 'error');
                                return;
                            }
                            
                            if (response.result && response.result.includes('SUCCESS: Payment link created')) {
                                // Extract the Stripe URL
                                const urlMatch = response.result.match(/https:\/\/checkout\.stripe\.com\/[^\s\n\r"'<>]+/);
                                if (urlMatch) {
                                    const paymentUrl = urlMatch[0];
                                    addLog(`‚úÖ Payment link created successfully!`, 'success');
                                    addDirectPaymentLink(paymentUrl, parameters.amount, parameters.description);
                                    updateScriptStatus(selectedScript, `Last run: ${new Date().toLocaleTimeString()}`);
                                    return;
                                }
                            }
                            
                            // If we can't extract the URL, show manual method
                            addLog(`‚úÖ Payment created! Using manual method.`, 'success');
                            
                            // Get amount and description from URL parameters
                            const urlParams = new URLSearchParams(requestUrl.split('?')[1]);
                            const amount = urlParams.get('amount') || parameters.amount;
                            const description = urlParams.get('description') || parameters.description;
                            
                            addSmartPaymentInterface(requestUrl, amount, description);
                        };
                        
                        // Handle script load errors
                        script.onerror = function() {
                            document.head.removeChild(script);
                            delete window[callbackName];
                            addLog(`‚ö†Ô∏è JSONP failed, using manual method`, 'info');
                            
                            // Get amount and description from URL parameters
                            const urlParams = new URLSearchParams(requestUrl.split('?')[1]);
                            const amount = urlParams.get('amount') || parameters.amount;
                            const description = urlParams.get('description') || parameters.description;
                            
                            addSmartPaymentInterface(requestUrl, amount, description);
                        };
                        
                        // Set timeout
                        setTimeout(() => {
                            if (window[callbackName]) {
                                document.head.removeChild(script);
                                delete window[callbackName];
                                addLog(`‚ö†Ô∏è Request timeout, using manual method`, 'info');
                                
                                // Get amount and description from URL parameters
                                const urlParams = new URLSearchParams(requestUrl.split('?')[1]);
                                const amount = urlParams.get('amount') || parameters.amount;
                                const description = urlParams.get('description') || parameters.description;
                                
                                addSmartPaymentInterface(requestUrl, amount, description);
                            }
                        }, 15000);
                        
                        script.src = jsonpUrl;
                        document.head.appendChild(script);
                        
                        updateScriptStatus(selectedScript, `Last run: ${new Date().toLocaleTimeString()}`);
                        return;
                        
                    } catch (error) {
                        addLog(`‚ö†Ô∏è JSONP setup failed: ${error.message}`, 'info');
                        
                        // Get amount and description from URL parameters
                        const urlParams = new URLSearchParams(requestUrl.split('?')[1]);
                        const amount = urlParams.get('amount') || parameters.amount;
                        const description = urlParams.get('description') || parameters.description;
                        
                        addSmartPaymentInterface(requestUrl, amount, description);
                        updateScriptStatus(selectedScript, `Last run: ${new Date().toLocaleTimeString()}`);
                        return;
                    }
                }
                
                // For other scripts, just show success
                addLog(`‚úÖ ${scripts[selectedScript].name} executed successfully`, 'success');
                updateScriptStatus(selectedScript, `Last run: ${new Date().toLocaleTimeString()}`);

            } catch (error) {
                addLog(`‚ùå Network Error: ${error.message}`, 'error');
                
                // Additional troubleshooting info
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    addLog(`üîß This might be a CORS or network issue. Try testing the URL directly in your browser.`, 'error');
                }
            } finally {
                resetExecuteButton();
                cancelSelection();
            }
        }

        function resetExecuteButton() {
            isLoading = false;
            executeBtn.disabled = false;
            executeBtn.innerHTML = 'Execute Script';
        }

        function addManualLinkOption(requestUrl) {
            const logItem = document.createElement('div');
            logItem.className = 'log-item success';
            
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>üí≥ <strong>Payment Link Created!</strong></div>
                <div style="margin-top: 10px;">
                    <a href="${requestUrl}" target="_blank" style="
                        display: inline-block;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 10px 20px;
                        text-decoration: none;
                        border-radius: 8px;
                        font-weight: 600;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        margin-right: 10px;
                    ">Get Payment Link</a>
                    <button onclick="navigator.clipboard.writeText('${requestUrl}')" style="
                        background: #4CAF50;
                        color: white;
                        border: none;
                        padding: 10px 15px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                    ">Copy URL</button>
                </div>
                <div style="margin-top: 8px; font-size: 12px; color: #666;">
                    Click "Get Payment Link" to open in new tab and copy the Stripe URL from there.
                </div>
            `;

            logsList.insertBefore(logItem, logsList.firstChild);
        }

        function addSmartPaymentInterface(requestUrl, amount, description) {
            const logItem = document.createElement('div');
            logItem.className = 'log-item success';
            
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>üí≥ <strong>Payment Link Generator</strong></div>
                <div style="margin-top: 15px; padding: 20px; background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border-radius: 12px; border: 2px solid #4CAF50;">
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">CHF ${amount}</div>
                        <div style="font-size: 16px; color: #555; margin-top: 5px;">${description}</div>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
                        <div style="font-weight: 600; color: #333; margin-bottom: 10px;">üìã Quick Copy - Generator URL:</div>
                        <div style="
                            background: #f8f9fa;
                            padding: 10px;
                            border-radius: 6px;
                            font-family: monospace;
                            font-size: 11px;
                            word-break: break-all;
                            cursor: pointer;
                            border: 1px solid #dee2e6;
                        " onclick="
                            navigator.clipboard.writeText('${requestUrl}').then(() => {
                                this.style.background = '#d1ecf1';
                                this.style.color = '#0c5460';
                                const original = this.innerHTML;
                                this.innerHTML = '‚úÖ COPIED! Paste this URL in any browser to get your payment link';
                                setTimeout(() => {
                                    this.style.background = '#f8f9fa';
                                    this.style.color = 'inherit';
                                    this.innerHTML = original;
                                }, 3000);
                            });
                        ">${requestUrl}</div>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 15px;">
                        <a href="${requestUrl}" target="_blank" style="
                            display: inline-block;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 15px 30px;
                            text-decoration: none;
                            border-radius: 10px;
                            font-weight: 700;
                            font-size: 18px;
                            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                            transition: transform 0.2s ease;
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            üöÄ Generate Payment Link
                        </a>
                    </div>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; border-radius: 8px; font-size: 14px;">
                        <div style="font-weight: 600; color: #856404; margin-bottom: 8px;">üí° Instructions:</div>
                        <ol style="margin: 0; padding-left: 20px; color: #856404;">
                            <li>Click "üöÄ Generate Payment Link" (opens new tab)</li>
                            <li>Copy the <strong>https://checkout.stripe.com/...</strong> URL</li>
                            <li>Share that Stripe URL with your customer</li>
                        </ol>
                    </div>
                    
                    <div id="pasteArea_${timestamp.replace(/:/g, '')}" style="
                        margin-top: 15px;
                        padding: 15px;
                        background: white;
                        border: 2px dashed #ccc;
                        border-radius: 8px;
                        text-align: center;
                        display: none;
                    ">
                        <div style="font-weight: 600; margin-bottom: 10px;">üìé Paste your Stripe link here:</div>
                        <input type="text" placeholder="Paste the https://checkout.stripe.com/... link here" style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            font-size: 14px;
                        " onpaste="
                            setTimeout(() => {
                                const url = this.value;
                                if (url.includes('checkout.stripe.com')) {
                                    const container = this.parentElement.parentElement;
                                    container.innerHTML = container.innerHTML + 
                                    '<div style=\\'margin-top: 15px; padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px;\\'>' +
                                    '<div style=\\'font-weight: 600; color: #155724; margin-bottom: 10px;\\'>‚úÖ Payment Link Ready!</div>' +
                                    '<div style=\\'font-family: monospace; font-size: 12px; word-break: break-all; background: white; padding: 8px; border-radius: 4px; cursor: pointer;\\' onclick=\\'navigator.clipboard.writeText(\\'' + url + '\\'); alert(\\'Copied to clipboard!\\');\\'>\\' + url + \\'</div>' +
                                    '</div>';
                                }
                            }, 100);
                        ">
                    </div>
                    
                    <div style="text-align: center; margin-top: 10px;">
                        <button onclick="
                            const pasteArea = document.getElementById('pasteArea_${timestamp.replace(/:/g, '')}');
                            if (pasteArea.style.display === 'none') {
                                pasteArea.style.display = 'block';
                                this.innerHTML = 'üîº Hide Paste Area';
                            } else {
                                pasteArea.style.display = 'none';
                                this.innerHTML = 'üìã Show Paste Area';
                            }
                        " style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 12px;
                        ">üìã Show Paste Area</button>
                    </div>
                </div>
            `;

            logsList.insertBefore(logItem, logsList.firstChild);
        }

        function addDirectPaymentLink(paymentUrl, amount, description) {
            const logItem = document.createElement('div');
            logItem.className = 'log-item success';
            
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>üí≥ <strong>Payment Link Created!</strong></div>
                <div style="margin-top: 10px; padding: 15px; background: #e8f5e8; border-radius: 8px; border: 1px solid #4CAF50;">
                    <div style="margin-bottom: 15px;">
                        <strong>üí∞ Amount:</strong> CHF ${amount}<br>
                        <strong>üìù Description:</strong> ${description}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                            <strong>üîó Payment Link (click to copy):</strong>
                        </div>
                        <div style="
                            background: white;
                            padding: 12px;
                            border-radius: 8px;
                            border: 2px solid #4CAF50;
                            font-family: monospace;
                            font-size: 12px;
                            word-break: break-all;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onclick="
                            navigator.clipboard.writeText('${paymentUrl}').then(() => {
                                this.style.background = '#d4edda';
                                this.style.borderColor = '#28a745';
                                const originalText = this.innerHTML;
                                this.innerHTML = '‚úÖ COPIED TO CLIPBOARD!';
                                setTimeout(() => {
                                    this.style.background = 'white';
                                    this.style.borderColor = '#4CAF50';
                                    this.innerHTML = originalText;
                                }, 2000);
                            }).catch(() => {
                                alert('Could not copy to clipboard. Please select and copy manually.');
                            });
                        " onmouseover="this.style.background='#f8f9fa';" onmouseout="this.style.background='white';">
                            ${paymentUrl}
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <a href="${paymentUrl}" target="_blank" style="
                            display: inline-block;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 12px 24px;
                            text-decoration: none;
                            border-radius: 8px;
                            font-weight: 600;
                            font-size: 16px;
                            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                            transition: transform 0.2s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            üöÄ Open Payment Page
                        </a>
                    </div>
                    
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 12px; color: #666; text-align: center;">
                        Ready to share! Just copy the link above and send it to your customer.
                    </div>
                </div>
            `;

            logsList.insertBefore(logItem, logsList.firstChild);
        }

        function addPaymentRequestToLog(requestUrl, amount, description) {
            const logItem = document.createElement('div');
            logItem.className = 'log-item success';
            
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>üí≥ <strong>Payment Link Ready!</strong></div>
                <div style="margin-top: 10px; padding: 15px; background: #e8f5e8; border-radius: 8px; border: 1px solid #4CAF50;">
                    <div style="margin-bottom: 10px;">
                        <strong>Amount:</strong> CHF ${amount}<br>
                        <strong>Description:</strong> ${description}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <a href="${requestUrl}" target="_blank" style="
                            display: inline-block;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 12px 24px;
                            text-decoration: none;
                            border-radius: 8px;
                            font-weight: 600;
                            font-size: 16px;
                            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                            margin-right: 10px;
                        ">üîó Get Payment Link</a>
                        <button onclick="navigator.clipboard.writeText('${requestUrl}')" style="
                            background: #4CAF50;
                            color: white;
                            border: none;
                            padding: 12px 20px;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            font-size: 16px;
                        ">üìã Copy URL</button>
                    </div>
                    <div style="font-size: 14px; color: #555; line-height: 1.4;">
                        <strong>Instructions:</strong><br>
                        1. Click "üîó Get Payment Link" to open the generator<br>
                        2. Copy the Stripe checkout URL from the new page<br>
                        3. Share the Stripe URL with your customer
                    </div>
                </div>
            `;

            logsList.insertBefore(logItem, logsList.firstChild);
        }

        function addPaymentLinkToLog(paymentUrl) {
            const logItem = document.createElement('div');
            logItem.className = 'log-item success';
            
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>üí≥ <strong>Payment Link Created!</strong></div>
                <div style="margin-top: 10px; padding: 10px; background: #e8f5e8; border-radius: 8px; border: 1px solid #4CAF50;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Click to copy payment link:</div>
                    <div style="
                        background: white;
                        padding: 8px;
                        border-radius: 4px;
                        font-family: monospace;
                        font-size: 12px;
                        word-break: break-all;
                        cursor: pointer;
                        border: 1px solid #ddd;
                    " onclick="
                        navigator.clipboard.writeText('${paymentUrl}').then(() => {
                            this.style.background = '#d4edda';
                            this.innerHTML = '‚úÖ Copied to clipboard!';
                            setTimeout(() => {
                                this.style.background = 'white';
                                this.innerHTML = '${paymentUrl}';
                            }, 2000);
                        });
                    ">${paymentUrl}</div>
                </div>
                <div style="margin-top: 10px;">
                    <a href="${paymentUrl}" target="_blank" style="
                        display: inline-block;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 8px 16px;
                        text-decoration: none;
                        border-radius: 6px;
                        font-weight: 600;
                        font-size: 14px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    ">Open Payment Page</a>
                </div>
            `;

            logsList.insertBefore(logItem, logsList.firstChild);
        }

        function addLog(message, type = 'info') {
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>${message}</div>
            `;

            // Remove "no logs" message if it exists
            const noLogs = logsList.querySelector('.no-logs');
            if (noLogs) {
                noLogs.remove();
            }

            logsList.insertBefore(logItem, logsList.firstChild);

            // Keep only last 10 logs
            const logs = logsList.querySelectorAll('.log-item');
            if (logs.length > 10) {
                logs[logs.length - 1].remove();
            }
        }

        function updateScriptStatus(scriptName, status) {
            const card = document.querySelector(`[data-script="${scriptName}"]`);
            const statusElement = card.querySelector('.script-status');
            statusElement.textContent = status;
        }

        // Add to home screen prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install prompt after a short delay
            setTimeout(() => {
                if (confirm('Add this app to your home screen for quick access?')) {
                    deferredPrompt.prompt();
                }
            }, 3000);
        });
    </script>
</body>
</html>
