<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Script Trigger">
    <title>Google Apps Script Trigger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 100%;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .url-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .url-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .url-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background-color: #fafafa;
            transition: border-color 0.3s ease;
        }

        .url-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .url-input:invalid {
            border-color: #f44336;
        }

        .test-url-btn {
            margin-top: 10px;
            padding: 10px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            touch-action: manipulation;
        }

        .test-url-btn:hover {
            background: #1976D2;
        }

        .scripts-section h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .script-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            touch-action: manipulation;
        }

        .script-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .script-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
        }

        .script-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .script-description {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .script-status {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        .parameter-inputs {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .parameter-inputs h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            touch-action: manipulation;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f44336;
            color: white;
        }

        .btn-secondary:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .loading-overlay.active {
            display: flex;
        }

        .logs-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .logs-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .log-item {
            padding: 10px;
            border-left: 3px solid #e1e5e9;
            margin-bottom: 10px;
            background: #f9f9f9;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
        }

        .log-item.success {
            border-left-color: #4CAF50;
            background: #f1f8e9;
        }

        .log-item.error {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .log-timestamp {
            font-size: 12px;
            color: #555;
            font-weight: 500;
        }

        .no-logs {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        .clear-logs-btn {
            margin-top: 10px;
            padding: 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            touch-action: manipulation;
        }

        .clear-logs-btn:hover {
            background: #5c636a;
        }

        .hidden {
            display: none;
        }

        .pwa-prompt {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }

        .pwa-prompt.active {
            display: block;
        }

        .pwa-prompt button {
            padding: 10px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            touch-action: manipulation;
        }

        .pwa-install-btn {
            background: #4CAF50;
            color: white;
        }

        .pwa-cancel-btn {
            background: #f44336;
            color: white;
        }

        .retry-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            touch-action: manipulation;
        }

        .retry-btn:hover {
            background: #1976D2;
        }

        .manual-link {
            margin-top: 10px;
            display: inline-block;
            padding: 8px 16px;
            background: #ff9800;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            touch-action: manipulation;
        }

        .manual-link:hover {
            background: #f57c00;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .button-row {
                flex-direction: column;
            }
            
            .btn {
                margin-bottom: 10px;
                padding: 10px;
                font-size: 12px;
            }

            .input-group input {
                font-size: 14px;
                padding: 10px;
            }

            .log-item {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading"></div>
    </div>
    
    <div class="pwa-prompt" id="pwaPrompt">
        <h3>Add to Home Screen</h3>
        <p>Install this app for quick access!</p>
        <button class="pwa-install-btn" id="installBtn">Install</button>
        <button class="pwa-cancel-btn" id="cancelPromptBtn">Not Now</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>üöÄ Script Trigger</h1>
            <p>Trigger your Google Apps Scripts from anywhere</p>
        </div>

        <div class="url-section">
            <label for="scriptUrl">Google Apps Script URL:</label>
            <input 
                type="url" 
                id="scriptUrl" 
                class="url-input"
                value="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"
                placeholder="Paste your Google Apps Script URL here"
                aria-describedby="scriptUrlHelp"
                required
            >
            <div id="scriptUrlHelp" class="script-description">
                Enter the URL of your Google Apps Script web app (e.g., https://script.google.com/macros/s/.../exec)
            </div>
            <button class="test-url-btn" id="testUrlBtn" aria-label="Test Script URL">Test URL</button>
        </div>

        <div class="scripts-section">
            <h2>üìã Available Scripts</h2>
            
            <div class="script-card" data-script="triggerDailyReport" role="button" tabindex="0">
                <div class="script-name">Generate Daily KM Report</div>
                <div class="script-description">Generates comprehensive daily report with vehicle data, revenue, and Stripe balance</div>
                <div class="script-status">Ready to execute</div>
            </div>

            <div class="script-card" data-script="triggerCustomDateReport" role="button" tabindex="0">
                <div class="script-name">Generate Report for Custom Date</div>
                <div class="script-description">Generates daily report for a specific date/time</div>
                <div class="script-status">Requires date input</div>
            </div>

            <div class="script-card" data-script="triggerHardcodedReport" role="button" tabindex="0">
                <div class="script-name">Run Hardcoded Date Report</div>
                <div class="script-description">Runs report for hardcoded date (2025-05-25)</div>
                <div class="script-status">Ready to execute</div>
            </div>

            <div class="script-card" data-script="triggerStripePayment" role="button" tabindex="0">
                <div class="script-name">üí≥ Create Stripe Payment Link</div>
                <div class="script-description">Creates a custom payment link with your specified amount and description</div>
                <div class="script-status">Requires amount and description</div>
            </div>
        </div>

        <div id="parameterInputs" class="parameter-inputs hidden">
            <h3>üìù Parameters</h3>
            <div id="inputFields"></div>
            <div class="button-row">
                <button id="executeBtn" class="btn btn-primary" aria-label="Execute Script">
                    Execute Script
                </button>
                <button id="cancelBtn" class="btn btn-secondary" aria-label="Cancel Selection">
                    Cancel
                </button>
            </div>
        </div>

        <div class="logs-section">
            <h3>üìä Execution Logs</h3>
            <div id="logsList">
                <div class="no-logs">No logs yet</div>
            </div>
            <button class="clear-logs-btn" id="clearLogsBtn" aria-label="Clear Logs">Clear Logs</button>
        </div>
    </div>

    <script>
        // Configuration
        const AUTH_TOKEN = "myAppToken2025"; // INSERT YOUR AUTH_TOKEN HERE (must match backend, e.g., myAppToken2025)
        const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // INSERT YOUR DEPLOYED /exec WEB APP URL HERE

        const scripts = {
            triggerDailyReport: {
                name: "Generate Daily KM Report",
                parameters: [],
            },
            triggerCustomDateReport: {
                name: "Generate Report for Custom Date",
                parameters: ["customDate"],
            },
            triggerHardcodedReport: {
                name: "Run Hardcoded Date Report",
                parameters: [],
            },
            triggerStripePayment: {
                name: "Create Stripe Payment Link",
                parameters: ["amount", "description"],
            },
        };

        let selectedScript = null;
        let parameters = {};
        let isLoading = false;
        let deferredPrompt = null;

        // DOM elements
        const scriptCards = document.querySelectorAll(".script-card");
        const parameterInputs = document.getElementById("parameterInputs");
        const inputFields = document.getElementById("inputFields");
        const executeBtn = document.getElementById("executeBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const logsList = document.getElementById("logsList");
        const scriptUrlInput = document.getElementById("scriptUrl");
        const testUrlBtn = document.getElementById("testUrlBtn");
        const clearLogsBtn = document.getElementById("clearLogsBtn");
        const loadingOverlay = document.getElementById("loadingOverlay");
        const pwaPrompt = document.getElementById("pwaPrompt");
        const installBtn = document.getElementById("installBtn");
        const cancelPromptBtn = document.getElementById("cancelPromptBtn");

        // Load logs from localStorage
        let logs = JSON.parse(localStorage.getItem("scriptTriggerLogs")) || [];
        renderLogs();

        // Check HTTPS and /dev URL on load
        if (window.location.protocol !== "https:" && window.location.hostname !== "localhost") {
            addLog("‚ö†Ô∏è This app must be served over HTTPS for mobile compatibility. Host on a secure server (e.g., Netlify).", "error");
        }
        if (scriptUrlInput.value.includes("/dev")) {
            addLog("‚ö†Ô∏è Invalid URL: Use the /exec URL from a deployed web app, not /dev.", "error");
        }

        // Event listeners
        scriptCards.forEach((card) => {
            card.addEventListener("click", () => selectScript(card.dataset.script));
            card.addEventListener("touchstart", () => selectScript(card.dataset.script), { passive: true });
            card.addEventListener("keydown", (e) => {
                if (e.key === "Enter" || e.key === " ") {
                    selectScript(card.dataset.script);
                }
            });
        });

        executeBtn.addEventListener("click", executeScript);
        executeBtn.addEventListener("touchstart", executeScript, { passive: true });
        cancelBtn.addEventListener("click", cancelSelection);
        testUrlBtn.addEventListener("click", testScriptUrl);
        testUrlBtn.addEventListener("touchstart", testScriptUrl, { passive: true });
        clearLogsBtn.addEventListener("click", clearLogs);
        installBtn.addEventListener("click", installPWA);
        cancelPromptBtn.addEventListener("click", () => pwaPrompt.classList.remove("active"));

        // Debounce input handler
        function debounce(fn, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn(...args), delay);
            };
        }

        // Validate URL format
        function validateScriptUrl(url) {
            const regex = /^https:\/\/script\.google\.com\/macros\/s\/[A-Za-z0-9_-]+\/exec$/;
            return regex.test(url);
        }

        // Sanitize input to prevent XSS
        function sanitizeInput(input) {
            const div = document.createElement("div");
            div.textContent = input;
            return div.innerHTML;
        }

        function selectScript(scriptName) {
            selectedScript = scriptName;
            parameters = {};

            scriptCards.forEach((card) => {
                card.classList.toggle("selected", card.dataset.script === scriptName);
                card.setAttribute("aria-selected", card.dataset.script === scriptName);
            });

            const script = scripts[scriptName];
            showParameterInputs(script, script.parameters.length === 0);
        }

        function showParameterInputs(script, noParams = false) {
            inputFields.innerHTML = "";

            if (!noParams) {
                script.parameters.forEach((param) => {
                    const inputGroup = document.createElement("div");
                    inputGroup.className = "input-group";

                    const label = document.createElement("label");
                    label.textContent =
                        param === "customDate"
                            ? "Date/Time (YYYY-MM-DD HH:MM):"
                            : param === "amount"
                            ? "Amount (CHF):"
                            : param === "description"
                            ? "Description/Reason:"
                            : `${param}:`;
                    label.setAttribute("for", `param-${param}`);

                    const input = document.createElement("input");
                    input.id = `param-${param}`;
                    input.type =
                        param === "customDate"
                            ? "datetime-local"
                            : param === "amount"
                            ? "number"
                            : "text";
                    input.step = param === "amount" ? "0.01" : undefined;
                    input.min = param === "amount" ? "0.01" : undefined;
                    input.placeholder =
                        param === "customDate"
                            ? "Select date and time"
                            : param === "amount"
                            ? "Enter amount in CHF (e.g., 150.00)"
                            : param === "description"
                            ? "Enter payment description (e.g., Noleggio Furgone - 3 giorni)"
                            : `Enter ${param}`;
                    input.setAttribute("aria-required", "true");

                    input.addEventListener(
                        "input",
                        debounce((e) => {
                            parameters[param] = sanitizeInput(e.target.value);
                        }, 300)
                    );

                    inputGroup.appendChild(label);
                    inputGroup.appendChild(input);
                    inputFields.appendChild(inputGroup);
                });
            }

            parameterInputs.classList.remove("hidden");
            parameterInputs.setAttribute("aria-hidden", "false");
        }

        function cancelSelection() {
            selectedScript = null;
            parameters = {};
            scriptCards.forEach((card) => {
                card.classList.remove("selected");
                card.setAttribute("aria-selected", "false");
            });
            parameterInputs.classList.add("hidden");
            parameterInputs.setAttribute("aria-hidden", "true");
        }

        async function testScriptUrl() {
            const scriptUrl = scriptUrlInput.value.trim();
            if (!scriptUrl) {
                addLog("Error: Please enter a Google Apps Script URL", "error");
                return;
            }
            if (!validateScriptUrl(scriptUrl)) {
                addLog("Error: Invalid Google Apps Script URL format. Use /exec, not /dev.", "error");
                return;
            }

            try {
                loadingOverlay.classList.add("active");
                const response = await fetch(`${scriptUrl}?function=ping&authToken=${AUTH_TOKEN}`);
                const data = await response.json();
                if (data.result) {
                    addLog("‚úÖ Script URL is valid", "success");
                } else {
                    addLog(`‚ùå Error: ${data.error}`, "error");
                    if (data.error.includes("Unauthorized")) {
                        addLog("üîë Authentication failed. Ensure AUTH_TOKEN matches the backend.", "error");
                    } else if (data.error.includes("login")) {
                        addLog("üîê Sign-in page detected. Use a deployed /exec URL with 'Anyone' access.", "error");
                    }
                }
            } catch (error) {
                addLog(`‚ùå Network Error: ${error.message}`, "error");
                addLog("‚ÑπÔ∏è Check if the app is served over HTTPS, pop-ups are allowed, and the URL uses /exec.", "error");
            } finally {
                loadingOverlay.classList.remove("active");
            }
        }

        async function executeScript() {
            if (!selectedScript || isLoading) return;

            isLoading = true;
            executeBtn.disabled = true;
            executeBtn.innerHTML = '<span class="loading"></span> Executing...';
            loadingOverlay.classList.add("active");

            const scriptUrl = scriptUrlInput.value.trim();
            if (!scriptUrl || !validateScriptUrl(scriptUrl)) {
                addLog("Error: Invalid Google Apps Script URL format. Use /exec, not /dev.", "error");
                resetExecuteButton();
                return;
            }

            try {
                let requestUrl = `${scriptUrl}?function=${selectedScript}&authToken=${AUTH_TOKEN}`;
                if (parameters.customDate) {
                    const dateValue = new Date(parameters.customDate);
                    requestUrl += `&customDateString=${encodeURIComponent(dateValue.toISOString())}`;
                }
                if (parameters.amount) {
                    requestUrl += `&amount=${encodeURIComponent(parameters.amount)}`;
                }
                if (parameters.description) {
                    requestUrl += `&description=${encodeURIComponent(parameters.description)}`;
                }

                if (selectedScript === "triggerStripePayment") {
                    const amount = parameters.amount || "0.00";
                    const description = parameters.description || "Payment";
                    addLog(`üí≥ Opening payment link generator...`, "info");
                    try {
                        const newWindow = window.open(requestUrl, "_blank");
                        if (!newWindow || newWindow.closed || typeof newWindow.closed === "undefined") {
                            addLog("‚ö†Ô∏è Pop-up blocked. Use the manual link below or allow pop-ups in your browser settings.", "error");
                            addPasteArea(amount, description, requestUrl, true);
                        } else {
                            addPasteArea(amount, description, requestUrl);
                        }
                    } catch (error) {
                        addLog(`‚ùå Pop-up error: ${error.message}. Use the manual link below.`, "error");
                        addPasteArea(amount, description, requestUrl, true);
                    }
                } else {
                    const response = await fetch(requestUrl);
                    const data = await response.json();
                    if (data.result) {
                        addLog(`‚úÖ ${scripts[selectedScript].name}: ${data.result}`, "success");
                        updateScriptStatus(selectedScript, `Last run: ${new Date().toLocaleTimeString()}`);
                    } else {
                        addLog(`‚ùå Error: ${data.error}`, "error");
                        if (data.error.includes("Unauthorized")) {
                            addLog("üîë Authentication failed. Ensure AUTH_TOKEN matches the backend.", "error");
                        } else if (data.error.includes("login")) {
                            addLog("üîê Sign-in page detected. Use a deployed /exec URL with 'Anyone' access.", "error");
                        }
                    }
                }
            } catch (error) {
                addLog(`‚ùå Network Error: ${error.message}`, "error");
                addLog("‚ÑπÔ∏è Check if the app is served over HTTPS, pop-ups are allowed, and the URL uses /exec.", "error");
            } finally {
                resetExecuteButton();
            }
        }

        function resetExecuteButton() {
            isLoading = false;
            executeBtn.disabled = false;
            executeBtn.innerHTML = "Execute Script";
            loadingOverlay.classList.remove("active");
            cancelSelection();
        }

        function addPasteArea(amount, description, requestUrl, popUpBlocked = false) {
            const timestamp = new Date().toLocaleTimeString();
            const pasteId = `pasteArea_${timestamp.replace(/:/g, "")}`;
            const logItem = document.createElement("div");
            logItem.className = "log-item success";
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>üí≥ <strong>Payment Link Generator</strong></div>
                <div style="margin-top: 10px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                    <div style="margin-bottom: 10px;">
                        <strong>Amount:</strong> CHF ${sanitizeInput(amount)}<br>
                        <strong>Description:</strong> ${sanitizeInput(description)}
                    </div>
                    <div style="margin-bottom: 10px; font-size: 14px; color: #333;">
                        <strong>Instructions:</strong><br>
                        1. ${popUpBlocked ? 'Click the "Manual Link" below' : 'Check the new tab'} for a JSON response like <code>{"result":"Payment link created: https://checkout.stripe.com/..."}</code><br>
                        2. Copy the URL starting with <code>https://checkout.stripe.com/</code><br>
                        3. Paste it below within 30 seconds
                    </div>
                    <div id="${pasteId}" style="padding: 10px; background: white; border: 2px dashed #ccc; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 10px;">üìé Paste your Stripe link here:</div>
                        <input type="text" placeholder="Paste the https://checkout.stripe.com/... link here" style="
                            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;
                        " aria-label="Paste Stripe Payment Link">
                        <button class="retry-btn" style="
                            margin-top: 10px; padding: 8px 16px; background: #2196F3; color: white;
                            border: none; border-radius: 6px; cursor: pointer;
                        ">Retry (Open Link Again)</button>
                        ${popUpBlocked ? `<a href="${requestUrl}" target="_blank" class="manual-link">Manual Link (Open in New Tab)</a>` : ''}
                    </div>
                </div>
            `;
            logsList.insertBefore(logItem, logsList.firstChild);
            saveLogs();

            const input = logItem.querySelector("input");
            const retryBtn = logItem.querySelector(".retry-btn");
            const pasteArea = logItem.querySelector(`#${pasteId}`);

            // Retry button
            retryBtn.addEventListener("click", () => {
                addLog("üîÑ Retrying payment link generation...", "info");
                try {
                    const newWindow = window.open(requestUrl, "_blank");
                    if (!newWindow) {
                        addLog("‚ö†Ô∏è Pop-up blocked. Use the manual link or allow pop-ups.", "error");
                    }
                } catch (error) {
                    addLog(`‚ùå Retry error: ${error.message}. Use the manual link.`, "error");
                }
            });

            // Paste handler
            input.addEventListener("paste", () => {
                setTimeout(() => {
                    try {
                        const url = sanitizeInput(input.value);
                        if (url.includes("checkout.stripe.com")) {
                            navigator.clipboard.writeText(url).catch(() => {
                                addLog("‚ö†Ô∏è Clipboard access denied. Manually copy the URL.", "error");
                            });
                            pasteArea.innerHTML = `
                                <div style="padding: 10px; background: #d4edda; border-radius: 8px;">
                                    <div style="font-weight: 600; color: #155724; margin-bottom: 10px;">‚úÖ Payment Link Copied!</div>
                                    <div style="font-family: monospace; font-size: 12px; word-break: break-all;">${url}</div>
                                    <a href="${url}" target="_blank" style="
                                        display: inline-block; background: #4CAF50; color: white; padding: 8px 16px;
                                        text-decoration: none; border-radius: 6px; margin-top: 10px;
                                    ">Open Payment Page</a>
                                </div>
                            `;
                            saveLogs();
                        } else {
                            addLog("‚ùå Invalid Stripe URL. Must start with https://checkout.stripe.com/", "error");
                        }
                    } catch (error) {
                        addLog(`‚ùå Paste error: ${error.message}`, "error");
                    }
                }, 100);
            });
            input.addEventListener("touchstart", () => input.focus(), { passive: true });

            // Timeout warning
            setTimeout(() => {
                if (pasteArea.querySelector("input")) {
                    addLog("‚ö†Ô∏è Please paste the Stripe URL within 30 seconds", "error");
                }
            }, 30000);
        }

        function addLog(message, type = "info") {
            const logItem = document.createElement("div");
            logItem.className = `log-item ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>${sanitizeInput(message)}</div>
            `;

            const noLogs = logsList.querySelector(".no-logs");
            if (noLogs) {
                noLogs.remove();
            }

            logsList.insertBefore(logItem, logsList.firstChild);
            logs.push({ message, type, timestamp });
            if (logs.length > 10) {
                logs.shift();
                logsList.lastChild.remove();
            }
            saveLogs();
        }

        function renderLogs() {
            logsList.innerHTML = "";
            if (logs.length === 0) {
                logsList.innerHTML = '<div class="no-logs">No logs yet</div>';
                return;
            }
            logs.forEach(({ message, type, timestamp }) => {
                const logItem = document.createElement("div");
                logItem.className = `log-item ${type}`;
                logItem.innerHTML = `
                    <div class="log-timestamp">[${timestamp}]</div>
                    <div>${sanitizeInput(message)}</div>
                `;
                logsList.appendChild(logItem);
            });
        }

        function saveLogs() {
            localStorage.setItem("scriptTriggerLogs", JSON.stringify(logs));
        }

        function clearLogs() {
            logs = [];
            logsList.innerHTML = '<div class="no-logs">No logs yet</div>';
            saveLogs();
        }

        function updateScriptStatus(scriptName, status) {
            const card = document.querySelector(`[data-script="${scriptName}"]`);
            const statusElement = card.querySelector(".script-status");
            statusElement.textContent = status;
        }

        // PWA installation prompt
        window.addEventListener("beforeinstallprompt", (e) => {
            e.preventDefault();
            deferredPrompt = e;
            setTimeout(() => {
                pwaPrompt.classList.add("active");
            }, 3000);
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt = null;
                pwaPrompt.classList.remove("active");
            }
        }
    </script>
</body>
</html>
