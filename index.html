<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Script Trigger">
    <title>Google Apps Script Trigger</title>
    <!-- Google Fonts: Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 100%;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #1E88E5; /* Primary color - Replace with your primary brand color (e.g., #FF5733) */
            border-radius: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header img.logo {
            max-height: 50px;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .scripts-section h2 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #333;
        }

        .script-button {
            display: block;
            width: 100%;
            background: #1E88E5; /* Primary color - Replace with your primary brand color (e.g., #FF5733) */
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            touch-action: manipulation;
        }

        .script-button:hover {
            background: #1565C0; /* Darker primary - Replace with a darker shade of your primary color (e.g., #E64A19) */
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .script-button:focus {
            outline: none;
            border: 2px solid #FBC02D; /* Secondary color - Replace with your secondary brand color (e.g., #28A745) */
        }

        .script-button.selected {
            background: #1565C0; /* Darker primary - Replace with a darker shade of your primary color (e.g., #E64A19) */
            border: 2px solid #FBC02D; /* Secondary color - Replace with your secondary brand color (e.g., #28A745) */
        }

        .script-description {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
            text-align: center;
        }

        .script-status {
            font-size: 11px;
            color: #999;
            font-style: italic;
            text-align: center;
            display: block;
            margin-top: 3px;
        }

        .parameter-inputs {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .parameter-inputs h3 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #333;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            touch-action: manipulation;
        }

        .input-group input:focus {
            outline: none;
            border-color: #1E88E5; /* Primary color - Replace with your primary brand color (e.g., #FF5733) */
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            touch-action: manipulation;
        }

        .btn-primary {
            background: #1E88E5; /* Primary color - Replace with your primary brand color (e.g., #FF5733) */
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1565C0; /* Darker primary - Replace with a darker shade of your primary color (e.g., #E64A19) */
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(30, 136, 229, 0.3); /* Adjust shadow color if primary changes */
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #D32F2F; /* Error color - Replace with your error brand color (e.g., #DC3545) */
            color: white;
        }

        .btn-secondary:hover {
            background: #B71C1C; /* Darker error - Replace with a darker shade of your error color (e.g., #C82333) */
            transform: translateY(-1px);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .loading-overlay.active {
            display: flex;
        }

        .logs-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .logs-section h3 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #333;
        }

        .log-item {
            padding: 10px;
            border-left: 3px solid #e1e5e9;
            margin-bottom: 10px;
            background: #f9f9f9;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
        }

        .log-item.success {
            border-left-color: #1E88E5; /* Primary color - Replace with your primary brand color (e.g., #FF5733) */
            background: #e3f2fd; /* Light primary - Replace with a light shade of your primary color (e.g., #FFF3E0) */
        }

        .log-item.error {
            border-left-color: #D32F2F; /* Error color - Replace with your error brand color (e.g., #DC3545) */
            background: #ffebee;
        }

        .log-timestamp {
            font-size: 12px;
            color: #555;
            font-weight: 500;
        }

        .no-logs {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        .clear-logs-btn {
            margin-top: 10px;
            padding: 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            touch-action: manipulation;
        }

        .clear-logs-btn:hover {
            background: #5c636a;
        }

        .hidden {
            display: none;
        }

        .pwa-prompt {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }

        .pwa-prompt.active {
            display: block;
        }

        .pwa-prompt button {
            padding: 10px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            touch-action: manipulation;
        }

        .pwa-install-btn {
            background: #1E88E5; /* Primary color - Replace with your primary brand color (e.g., #FF5733) */
            color: white;
        }

        .pwa-cancel-btn {
            background: #D32F2F; /* Error color - Replace with your error brand color (e.g., #DC3545) */
            color: white;
        }

        .stripe-link {
            margin-top: 10px;
            display: inline-block;
            padding: 8px 16px;
            background: #1E88E5; /* Primary color - Replace with your primary brand color (e.g., #FF5733) */
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            touch-action: manipulation;
        }

        .stripe-link:hover {
            background: #1565C0; /* Darker primary - Replace with a darker shade of your primary color (e.g., #E64A19) */
        }

        .copy-btn {
            margin-top: 10px;
            margin-left: 10px;
            padding: 8px 16px;
            background: #FBC02D; /* Secondary color - Replace with your secondary brand color (e.g., #28A745) */
            color: #333;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            touch-action: manipulation;
        }

        .copy-btn:hover {
            background: #F9A825; /* Darker secondary - Replace with a darker shade of your secondary color (e.g., #218838) */
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .button-row {
                flex-direction: column;
            }
            
            .btn {
                margin-bottom: 10px;
                padding: 10px;
                font-size: 12px;
            }

            .input-group input {
                font-size: 14px;
                padding: 10px;
            }

            .log-item {
                font-size: 13px;
            }

            .copy-btn {
                margin-left: 0;
                margin-top: 5px;
            }

            .script-button {
                font-size: 14px;
                padding: 12px;
            }

            .script-description {
                font-size: 11px;
            }

            .script-status {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading"></div>
    </div>
    
    <div class="pwa-prompt" id="pwaPrompt">
        <h3>Add to Home Screen</h3>
        <p>Install this app for quick access!</p>
        <button class="pwa-install-btn" id="installBtn">Install</button>
        <button class="pwa-cancel-btn" id="cancelPromptBtn">Not Now</button>
    </div>

    <div class="container">
        <div class="header">
            <img src="https://raw.githubusercontent.com/SandroZellweger/script-trigger-app/refs/heads/main/NOL_Noleggio-semplice_Visto_RGB_1500px.jpg" alt="Company Logo" class="logo">
            <!-- Replace the src above with your logo URL, e.g., https://sandrozellweger.github.io/script-trigger-app/script-trigger-app
/NOL_Noleggio-semplice_Visto_RGB_1500px.jpg -->
            <h1>🚀 Script Trigger</h1>
            <p>Trigger your Google Apps Scripts from anywhere</p>
        </div>

        <div class="scripts-section">
            <h2>📋 Available Scripts</h2>
            
            <button class="script-button" data-script="triggerDailyReport" role="button" tabindex="0">
                Generate Daily KM Report
                <span class="script-description">Generates comprehensive daily report with vehicle data, revenue, and Stripe balance</span>
                <span class="script-status">Ready to execute</span>
            </button>

            <button class="script-button" data-script="triggerCustomDateReport" role="button" tabindex="0">
                Generate Report for Custom Date
                <span class="script-description">Generates daily report for a specific date/time</span>
                <span class="script-status">Requires date input</span>
            </button>

            <button class="script-button" data-script="triggerHardcodedReport" role="button" tabindex="0">
                Run Hardcoded Date Report
                <span class="script-description">Runs report for hardcoded date (2025-05-25)</span>
                <span class="script-status">Ready to execute</span>
            </button>

            <button class="script-button" data-script="triggerStripePayment" role="button" tabindex="0">
                💳 Create Stripe Payment Link
                <span class="script-description">Creates a custom payment link with your specified amount and description</span>
                <span class="script-status">Requires amount and description</span>
            </button>
        </div>

        <div id="parameterInputs" class="parameter-inputs hidden">
            <h3>📝 Parameters</h3>
            <div id="inputFields"></div>
            <div class="button-row">
                <button id="executeBtn" class="btn btn-primary" aria-label="Execute Script">
                    Execute Script
                </button>
                <button id="cancelBtn" class="btn btn-secondary" aria-label="Cancel Selection">
                    Cancel
                </button>
            </div>
        </div>

        <div class="logs-section">
            <h3>📊 Execution Logs</h3>
            <div id="logsList">
                <div class="no-logs">No logs yet</div>
            </div>
            <button class="clear-logs-btn" id="clearLogsBtn" aria-label="Clear Logs">Clear Logs</button>
        </div>
    </div>

    <script>
        // Configuration
        const AUTH_TOKEN = "myAppToken2025"; // Matches backend
        const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwnRZPNwsZ6ogyoobm3lBCvfANmX6B8qlLOpTlmfuurJaxnrXQnyGVfQiTtfviHLqZupA/exec"; // Hardcoded script URL

        const scripts = {
            triggerDailyReport: {
                name: "Generate Daily KM Report",
                parameters: [],
            },
            triggerCustomDateReport: {
                name: "Generate Report for Custom Date",
                parameters: ["customDate"],
            },
            triggerHardcodedReport: {
                name: "Run Hardcoded Date Report",
                parameters: [],
            },
            triggerStripePayment: {
                name: "Create Stripe Payment Link",
                parameters: ["amount", "description"],
            },
        };

        let selectedScript = null;
        let parameters = {};
        let isLoading = false;
        let deferredPrompt = null;

        // DOM elements
        const scriptButtons = document.querySelectorAll(".script-button");
        const parameterInputs = document.getElementById("parameterInputs");
        const inputFields = document.getElementById("inputFields");
        const executeBtn = document.getElementById("executeBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const logsList = document.getElementById("logsList");
        const loadingOverlay = document.getElementById("loadingOverlay");
        const pwaPrompt = document.getElementById("pwaPrompt");
        const installBtn = document.getElementById("installBtn");
        const cancelPromptBtn = document.getElementById("cancelPromptBtn");

        // Load logs from localStorage
        let logs = JSON.parse(localStorage.getItem("scriptTriggerLogs")) || [];
        renderLogs();

        // Check HTTPS on load (no /dev check since URL is hardcoded)
        if (window.location.protocol !== "https:" && window.location.hostname !== "localhost") {
            addLog("⚠️ This app must be served over HTTPS for mobile compatibility. Host on a secure server (e.g., Netlify, GitHub Pages).", "error");
        }

        // Event listeners
        scriptButtons.forEach((button) => {
            button.addEventListener("click", () => selectScript(button.dataset.script));
            button.addEventListener("touchstart", () => selectScript(button.dataset.script), { passive: true });
            button.addEventListener("keydown", (e) => {
                if (e.key === "Enter" || e.key === " ") {
                    selectScript(button.dataset.script);
                }
            });
        });

        executeBtn.addEventListener("click", executeScript);
        executeBtn.addEventListener("touchstart", executeScript, { passive: true });
        cancelBtn.addEventListener("click", cancelSelection);
        clearLogsBtn.addEventListener("click", clearLogs);
        installBtn.addEventListener("click", installPWA);
        cancelPromptBtn.addEventListener("click", () => pwaPrompt.classList.remove("active"));

        // Debounce input handler
        function debounce(fn, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn(...args), delay);
            };
        }

        function sanitizeInput(input) {
            const div = document.createElement("div");
            div.textContent = input;
            return div.innerHTML;
        }

        function selectScript(scriptName) {
            selectedScript = scriptName;
            parameters = {};

            scriptButtons.forEach((button) => {
                button.classList.toggle("selected", button.dataset.script === scriptName);
                button.setAttribute("aria-selected", button.dataset.script === scriptName);
            });

            const script = scripts[scriptName];
            showParameterInputs(script, script.parameters.length === 0);
        }

        function showParameterInputs(script, noParams = false) {
            inputFields.innerHTML = "";

            if (!noParams) {
                script.parameters.forEach((param) => {
                    const inputGroup = document.createElement("div");
                    inputGroup.className = "input-group";

                    const label = document.createElement("label");
                    label.textContent =
                        param === "customDate"
                            ? "Date/Time (YYYY-MM-DD HH:MM):"
                            : param === "amount"
                            ? "Amount (CHF):"
                            : param === "description"
                            ? "Description/Reason:"
                            : `${param}:`;
                    label.setAttribute("for", `param-${param}`);

                    const input = document.createElement("input");
                    input.id = `param-${param}`;
                    input.type =
                        param === "customDate"
                            ? "datetime-local"
                            : param === "amount"
                            ? "number"
                            : "text";
                    input.step = param === "amount" ? "0.01" : undefined;
                    input.min = param === "amount" ? "0.01" : undefined;
                    input.placeholder =
                        param === "customDate"
                            ? "Select date and time"
                            : param === "amount"
                            ? "Enter amount in CHF (e.g., 150.00)"
                            : param === "description"
                            ? "Enter payment description (e.g., Noleggio Furgone - 3 giorni)"
                            : `Enter ${param}`;
                    input.setAttribute("aria-required", "true");

                    input.addEventListener(
                        "input",
                        debounce((e) => {
                            parameters[param] = sanitizeInput(e.target.value);
                        }, 300)
                    );

                    inputGroup.appendChild(label);
                    inputGroup.appendChild(input);
                    inputFields.appendChild(inputGroup);
                });
            }

            parameterInputs.classList.remove("hidden");
            parameterInputs.setAttribute("aria-hidden", "false");
        }

        function cancelSelection() {
            selectedScript = null;
            parameters = {};
            scriptButtons.forEach((button) => {
                button.classList.remove("selected");
                button.setAttribute("aria-selected", "false");
            });
            parameterInputs.classList.add("hidden");
            parameterInputs.setAttribute("aria-hidden", "true");
        }

        async function executeScript() {
            if (!selectedScript || isLoading) return;

            isLoading = true;
            executeBtn.disabled = true;
            executeBtn.innerHTML = '<span class="loading"></span> Executing...';
            loadingOverlay.classList.add("active");

            try {
                let requestUrl = `${DEFAULT_SCRIPT_URL}?function=${selectedScript}&authToken=${AUTH_TOKEN}`;
                if (parameters.customDate) {
                    const dateValue = new Date(parameters.customDate);
                    requestUrl += `&customDateString=${encodeURIComponent(dateValue.toISOString())}`;
                }
                if (parameters.amount) {
                    requestUrl += `&amount=${encodeURIComponent(parameters.amount)}`;
                }
                if (parameters.description) {
                    requestUrl += `&description=${encodeURIComponent(parameters.description)}`;
                }

                const response = await fetch(requestUrl);
                const data = await response.json();

                if (data.result) {
                    if (selectedScript === "triggerStripePayment") {
                        const amount = parameters.amount || "0.00";
                        const description = parameters.description || "Payment";
                        // Extract the URL from the result (remove "Payment link created: ")
                        const paymentUrlMatch = data.result.match(/https:\/\/checkout\.stripe\.com\/[^\s]+/);
                        if (paymentUrlMatch) {
                            const paymentUrl = paymentUrlMatch[0];
                            addLog(`✅ Stripe Payment Link Generated`, "success");
                            addStripeLink(amount, description, paymentUrl);
                        } else {
                            addLog("❌ Error: Could not extract Stripe URL from response.", "error");
                        }
                    } else {
                        addLog(`✅ ${scripts[selectedScript].name}: ${data.result}`, "success");
                        updateScriptStatus(selectedScript, `Last run: ${new Date().toLocaleTimeString()}`);
                    }
                } else {
                    addLog(`❌ Error: ${data.error}`, "error");
                    if (data.error.includes("Unauthorized")) {
                        addLog("🔑 Authentication failed. Ensure AUTH_TOKEN matches the backend.", "error");
                    } else if (data.error.includes("login")) {
                        addLog("🔐 Sign-in page detected. Ensure the script is deployed with 'Anyone' access.", "error");
                    }
                }
            } catch (error) {
                addLog(`❌ Network Error: ${error.message}`, "error");
                addLog("ℹ️ Ensure the app is served over HTTPS.", "error");
            } finally {
                resetExecuteButton();
            }
        }

        function resetExecuteButton() {
            isLoading = false;
            executeBtn.disabled = false;
            executeBtn.innerHTML = "Execute Script";
            loadingOverlay.classList.remove("active");
            cancelSelection();
        }

        function addStripeLink(amount, description, paymentUrl) {
            const timestamp = new Date().toLocaleTimeString();
            const logId = `log_${timestamp.replace(/:/g, "")}`;
            const logItem = document.createElement("div");
            logItem.className = "log-item success";
            logItem.id = logId;
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>💳 <strong>Payment Link Generated</strong></div>
                <div style="margin-top: 10px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                    <div style="margin-bottom: 10px;">
                        <strong>Amount:</strong> CHF ${sanitizeInput(amount)}<br>
                        <strong>Description:</strong> ${sanitizeInput(description)}
                    </div>
                    <div style="font-family: monospace; font-size: 12px; word-break: break-all; margin-bottom: 10px;">
                        ${sanitizeInput(paymentUrl)}
                    </div>
                    <a href="${paymentUrl}" target="_blank" class="stripe-link">Open Payment Page</a>
                    <button class="copy-btn" data-url="${paymentUrl}">Copy Link</button>
                </div>
            `;
            logsList.insertBefore(logItem, logsList.firstChild);
            saveLogs();

            // Add event listener for copy button
            const copyBtn = logItem.querySelector(".copy-btn");
            copyBtn.addEventListener("click", () => {
                const url = copyBtn.getAttribute("data-url");
                navigator.clipboard.writeText(url).then(() => {
                    addLog("✅ URL copied to clipboard", "success");
                }).catch(() => {
                    addLog("⚠️ Clipboard access denied. Select and copy the URL manually.", "error");
                });
            });
        }

        function addLog(message, type = "info") {
            const logItem = document.createElement("div");
            logItem.className = `log-item ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            logItem.innerHTML = `
                <div class="log-timestamp">[${timestamp}]</div>
                <div>${sanitizeInput(message)}</div>
            `;

            const noLogs = logsList.querySelector(".no-logs");
            if (noLogs) {
                noLogs.remove();
            }

            logsList.insertBefore(logItem, logsList.firstChild);
            logs.push({ message, type, timestamp });
            if (logs.length > 10) {
                logs.shift();
                logsList.lastChild.remove();
            }
            saveLogs();
        }

        function renderLogs() {
            logsList.innerHTML = "";
            if (logs.length === 0) {
                logsList.innerHTML = '<div class="no-logs">No logs yet</div>';
                return;
            }
            logs.forEach(({ message, type, timestamp }) => {
                const logItem = document.createElement("div");
                logItem.className = `log-item ${type}`;
                logItem.innerHTML = `
                    <div class="log-timestamp">[${timestamp}]</div>
                    <div>${sanitizeInput(message)}</div>
                `;
                logsList.appendChild(logItem);
            });
        }

        function saveLogs() {
            localStorage.setItem("scriptTriggerLogs", JSON.stringify(logs));
        }

        function clearLogs() {
            logs = [];
            logsList.innerHTML = '<div class="no-logs">No logs yet</div>';
            saveLogs();
        }

        function updateScriptStatus(scriptName, status) {
            const button = document.querySelector(`[data-script="${scriptName}"]`);
            const statusElement = button.querySelector(".script-status");
            statusElement.textContent = status;
        }

        // PWA installation prompt
        window.addEventListener("beforeinstallprompt", (e) => {
            e.preventDefault();
            deferredPrompt = e;
            setTimeout(() => {
                pwaPrompt.classList.add("active");
            }, 3000);
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt = null;
                pwaPrompt.classList.remove("active");
            }
        }
    </script>
</body>
</html>
