<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Calendar & CRM">
    <title>Calendar & CRM - Van Rentals</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;            box-sizing: border-box;
        }

        /* Calendar Selector Styles */
        .calendar-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin-top: 5px;
        }

        .calendar-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            border: 1px solid #e1e5e9;
            transition: all 0.2s ease;
        }

        .calendar-checkbox-item:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .calendar-checkbox-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .calendar-checkbox-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
            flex-shrink: 0;
        }        .calendar-checkbox-item label {
            font-size: 12px;
            color: #333;
            cursor: pointer;
            margin: 0;
            flex-grow: 1;
            user-select: none;
        }

        /* Tab System Styles */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            padding-bottom: 10px;
        }

        .tab-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #333;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .tab-btn.active {
            background: #4285f4;
            color: white;
            box-shadow: 0 4px 12px rgba(66,133,244,0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .dashboard-card h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .stats-toggle {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .stats-btn {
            background: #f0f2f5;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .stats-btn:hover {
            background: #e4e6ea;
        }

        .stats-btn.active {
            background: #4285f4;
            color: white;
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }

        .schedule-container, .ratings-container, .customers-container, .revenue-container, .utilization-container {
            font-size: 13px;
            line-height: 1.4;
        }

        .customer-rating {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f2f5;
        }

        .customer-rating:last-child {
            border-bottom: none;
        }

        .rating-stars {
            color: #ffc107;
        }

        .revenue-item, .utilization-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }

        .metric-value {
            font-weight: 600;
            color: #2e7d32;
        }

        .utilization-bar {
            width: 100%;
            height: 8px;
            background: #f0f2f5;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }

        .utilization-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.3s ease;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #7DBB35 0%, #5a8827 100%);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }        /* Tablet responsive design */
        @media screen and (max-width: 1100px) {
            .calendar-grid {
                grid-template-columns: 1fr 350px;
                gap: 20px;
            }
        }        /* Mobile responsive design */
        @media screen and (max-width: 900px) {
            .calendar-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .calendar-day {
                min-height: 80px;
                padding: 4px;
            }
            
            .day-number {
                font-size: 12px;
            }
            
            .event-pill {
                font-size: 8px;
                padding: 2px 4px;
                min-height: 14px;
            }
        }        @media screen and (max-width: 768px) {
            .container {
                padding: 10px;
                max-width: 100%;
            }
            
            .header {
                padding: 15px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 24px;
                margin-bottom: 10px;
            }
            
            .controls {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .control-group {
                flex-direction: column;
                width: 100%;
            }
            
            .calendar-section {
                padding: 15px;
            }
            
            .calendar-day {
                min-height: 70px;
                padding: 4px;
            }
            
            .day-number {
                font-size: 12px;
                margin-bottom: 2px;
            }
            
            .event-pill {
                font-size: 8px;
                padding: 2px 4px;
                min-height: 14px;
                margin-bottom: 1px;
            }
            
            /* Prevent text overflow in small screens */
            .event-pill {
                max-width: 100%;
                text-overflow: ellipsis;
                white-space: nowrap;
                overflow: hidden;
            }
            
            /* Fix CRM buttons on mobile */
            .crm-controls > div {
                grid-template-columns: 1fr !important;
                gap: 5px;
            }
            
            .crm-controls button {
                padding: 8px !important;
                font-size: 11px !important;
            }
        }

        @media screen and (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .calendar-section {
                padding: 10px;
            }
            
            .calendar-day {
                min-height: 50px;
                padding: 2px;
            }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;            padding: 25px;
            background: #FFFFFF;
            border-radius: 20px;
            color: #333;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #333;
        }

        .header p {
            font-size: 16px;
            opacity: 0.8;
            color: #555;
        }        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #FFFFFF;
            border: none;
            border-radius: 12px;
            padding: 12px 16px;
            text-decoration: none;
            color: #333;
            font-weight: 500;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }        .controls {
            background: #FFFFFF;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .control-group select, .control-group input {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: #fff;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .refresh-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }        .calendar-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 25px;
            margin-bottom: 20px;
            max-width: 100%;
        }

        .calendar-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #5a6fd8;
            transform: scale(1.1);
        }

        .month-year {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e1e5e9;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: #f8f9fa;
            padding: 10px 5px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            color: #666;
        }        .calendar-day {
            background: white;
            min-height: 110px;
            padding: 6px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e1e5e9;
            display: flex;
            flex-direction: column;
        }

        .calendar-day:hover {
            background: #f0f8ff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            color: #ccc;
        }

        .calendar-day.today {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid #667eea;
        }

        .day-number {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
            text-align: center;
            flex-shrink: 0;
        }

        .day-events {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex-grow: 1;
            overflow: hidden;
        }

        .event-pill {
            background: #667eea;
            color: white;
            font-size: 9px;
            padding: 3px 6px;
            border-radius: 12px;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            line-height: 1.2;
            min-height: 16px;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .event-pill:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 10;
            position: relative;
        }.event-pill.calendar-0 { background: #667eea; } /* Main Calendar - Blue */
        .event-pill.calendar-1 { background: #FF6B6B; } /* N01 - Opel Vivaro (Losone) - Red */
        .event-pill.calendar-2 { background: #4ECDC4; } /* N03 - Peugeot Boxer (Bellinzona) - Teal */
        .event-pill.calendar-3 { background: #45B7D1; } /* N04 - Fiat Ducato (Locarno) - Light Blue */
        .event-pill.calendar-4 { background: #96CEB4; } /* N06 - Citroen Jumper (Minusio) - Green */
        .event-pill.calendar-5 { background: #FECA57; } /* N07 - Renault Trafic (Lugano) - Yellow */
        .event-pill.calendar-6 { background: #FF9FF3; } /* N08 - Renault Trafic (Lugano) - Pink */
        .event-pill.calendar-7 { background: #54A0FF; } /* N09 - Renault Trafic (Bellinzona) - Blue */
        .event-pill.calendar-8 { background: #5F27CD; } /* N10 - Citroen Jumper (Losone) - Purple */
        .event-pill.calendar-9 { background: #00D2D3; } /* N11 - Citroen Jumper (Losone) - Cyan */

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .event-details {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .event-details h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .no-event {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        .event-info {
            margin-bottom: 15px;
        }

        .event-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .event-meta {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 14px;
            color: #666;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meta-icon {
            width: 16px;
            text-align: center;
        }

        .customer-crm {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .customer-crm h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .crm-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .rental-history {
            margin-top: 15px;
        }

        .history-item {
            background: rgba(248, 249, 250, 0.8);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
        }

        .history-date {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .history-details {
            font-size: 14px;
            color: #333;
            margin-top: 3px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-confirmed { background: #4CAF50; }
        .status-pending { background: #FF9800; }
        .status-cancelled { background: #f44336; }

        @media (max-width: 1024px) {
            .calendar-grid {
                grid-template-columns: 1fr;
            }
           
            .sidebar {
                grid-row: 1;
            }
           
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
           
            .control-group {
                justify-content: space-between;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
           
            .header {
                padding: 20px;
                margin-top: 60px;
            }
           
            .calendar-day {
                min-height: 60px;
            }
           
            .crm-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .van-legend {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .van-legend h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }

        .legend-item {
            padding: 4px 0;
            transition: background 0.2s ease;
        }

        .legend-item:hover {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
            padding-left: 4px;
        }

        .legend-color {
            display: inline-block;
            flex-shrink: 0;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .calendar-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
        }

        .calendar-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }

        .calendar-checkbox-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .calendar-checkbox-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .calendar-checkbox-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .calendar-checkbox-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media screen and (max-width: 768px) {
            .calendar-selector {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .calendar-checkbox-item {
                font-size: 12px;
                padding: 5px 8px;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-button">
        <span>←</span>
        Back to Home
    </a>

    <div class="container">
        <div class="header animate-in">
            <h1>📅 Van Rental Calendar & CRM</h1>
            <p>Manage bookings and customer relationships</p>
        </div>        <div class="controls animate-in">
            <div class="control-group">
                <label for="calendarFilter">Calendar Filter:</label>
                <select id="calendarFilter">
                    <option value="all">All Calendars</option>
                    <option value="0">Main Calendar</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Select Calendars to Display:</label>
                <div class="calendar-selector" id="calendarSelector">
                    <!-- Dynamic calendar checkboxes will be added here -->
                </div>
            </div>
                    <option value="1">N01 - Opel Vivaro (Losone)</option>
                    <option value="2">N03 - Peugeot Boxer (Bellinzona)</option>
                    <option value="3">N04 - Fiat Ducato (Locarno)</option>
                    <option value="4">N06 - Citroen Jumper (Minusio)</option>
                    <option value="5">N07 - Renault Trafic (Lugano)</option>
                    <option value="6">N08 - Renault Trafic (Lugano)</option>
                    <option value="7">N09 - Renault Trafic (Bellinzona)</option>
                    <option value="8">N10 - Citroen Jumper (Losone)</option>
                    <option value="9">N11 - Citroen Jumper (Losone)</option>
                </select>
            </div>
           
            <div class="control-group">
                <label for="dateRange">View:</label>
                <select id="dateRange">
                    <option value="month">Month View</option>
                    <option value="week">Week View</option>
                    <option value="day">Day View</option>
                </select>
            </div>
           
            <button class="refresh-btn" id="refreshBtn" onclick="loadCalendarData()">
                <span id="refreshIcon">🔄</span>
                Refresh Data
            </button>
           
            <div class="control-group">
                <span class="status-indicator status-confirmed"></span>
                <span style="font-size: 12px;">Confirmed</span>
                <span class="status-indicator status-pending"></span>
                <span style="font-size: 12px;">Pending</span>
                <span class="status-indicator status-cancelled"></span>
                <span style="font-size: 12px;">Cancelled</span>
            </div>
        </div>

        <div class="calendar-grid">
            <div class="calendar-section animate-in">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="nav-btn" onclick="navigateMonth(-1)">‹</button>
                        <div class="month-year" id="currentMonthYear">December 2024</div>
                        <button class="nav-btn" onclick="navigateMonth(1)">›</button>
                    </div>
                    <button class="nav-btn" onclick="goToToday()" title="Go to Today">📍</button>
                </div>
               
                <div class="calendar-view" id="calendarView">
                    <!-- Calendar will be generated here -->
                </div>
            </div>

            <div class="sidebar">
                <div class="event-details animate-in">
                    <h3>📋 Event Details</h3>
                    <div id="eventInfo" class="no-event">
                        Select an event to view details
                    </div>
                </div>                <div class="customer-crm animate-in">
                    <h3>👤 Customer CRM System</h3>
                      <!-- CRM Controls -->
                    <div class="crm-controls" style="margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <button 
                                id="buildQuickCrmBtn" 
                                type="button" 
                                style="padding: 12px; background: #34a853; color: white; border: none; border-radius: 8px; font-size: 13px; cursor: pointer;">
                                ⚡ Quick CRM (3 months)
                            </button>
                            <button 
                                id="buildCrmBtn" 
                                type="button" 
                                style="padding: 12px; background: #4285f4; color: white; border: none; border-radius: 8px; font-size: 13px; cursor: pointer;">
                                📊 Complete CRM (1 year)
                            </button>
                        </div>
                        
                        <button 
                            id="openCrmSpreadsheetBtn" 
                            type="button" 
                            style="width: 100%; padding: 12px; background: #34a853; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;"
                            disabled>
                            📋 Open CRM Spreadsheet
                        </button>
                    </div>
                    
                    <!-- CRM Status -->
                    <div id="crmStatus" style="display: none; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 13px;"></div>
                    
                    <!-- Customer Info (Selected from calendar) -->
                    <div id="customerInfo">
                        <div class="no-event">
                            Select a booking to view customer data<br>
                            <small style="color: #666;">Or build the CRM database for complete analytics</small>
                        </div>
                    </div>
                    
                    <!-- CRM Analytics Summary -->
                    <div id="crmAnalytics" style="display: none; margin-top: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #333; font-size: 16px;">📈 Business Analytics</h4>
                        <div id="crmStatsGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;">
                            <div class="stat-card" style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                <div id="totalCustomers" style="font-size: 20px; font-weight: bold; color: #4285f4;">-</div>
                                <div style="font-size: 11px; color: #666;">Customers</div>
                            </div>
                            <div class="stat-card" style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                                <div id="totalBookings" style="font-size: 20px; font-weight: bold; color: #34a853;">-</div>
                                <div style="font-size: 11px; color: #666;">Bookings</div>
                            </div>
                        </div>
                        <div id="crmInsightsList" style="background: #e3f2fd; padding: 10px; border-radius: 6px; font-size: 12px; color: #1976d2;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Van Fleet Legend -->
        <div class="van-legend animate-in" style="margin-top: 20px;">
            <h3>🚐 Van Fleet</h3>            <div class="legend-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                    <span class="legend-color" style="width: 12px; height: 12px; border-radius: 50%; background: #667eea;"></span>
                    <span>Main Calendar</span>
                </div>
                <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                    <span class="legend-color" style="width: 12px; height: 12px; border-radius: 50%; background: #FF6B6B;"></span>
                    <span>N01 - Opel Vivaro (Losone)</span>
                </div>
                <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                    <span class="legend-color" style="width: 12px; height: 12px; border-radius: 50%; background: #4ECDC4;"></span>
                    <span>N03 - Peugeot Boxer (Bellinzona)</span>
                </div>
                <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                    <span class="legend-color" style="width: 12px; height: 12px; border-radius: 50%; background: #45B7D1;"></span>
                    <span>N04 - Fiat Ducato (Locarno)</span>
                </div>
                <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                    <span class="legend-color" style="width: 12px; height: 12px; border-radius: 50%; background: #96CEB4;"></span>
                    <span>N06 - Citroen Jumper (Minusio)</span>
                </div>
                <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                    <span class="legend-color" style="width: 12px; height: 12px; border-radius: 50%; background: #FECA57;"></span>
                    <span>N07 - Renault Trafic (Lugano)</span>
                </div>
                <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                    <span class="legend-color" style="width: 12px; height: 12px; border-radius: 50%; background: #FF9FF3;"></span>
                    <span>N08 - Renault Trafic (Lugano)</span>
                </div>
                <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                    <span class="legend-color" style="width: 12px; height: 12px; border-radius: 50%; background: #54A0FF;"></span>
                    <span>N09 - Renault Trafic (Bellinzona)</span>
                </div>
                <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                    <span class="legend-color" style="width: 12px; height: 12px; border-radius: 50%; background: #5F27CD;"></span>
                    <span>N10 - Citroen Jumper (Losone)</span>
                </div>
                <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                    <span class="legend-color" style="width: 12px; height: 12px; border-radius: 50%; background: #00D2D3;"></span>
                    <span>N11 - Citroen Jumper (Losone)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to get settings from localStorage with error handling
        function getSettings() {
            // Correct script URL that is confirmed to work
            const defaultSettings = {
                scriptUrl: 'https://script.google.com/macros/s/AKfycbwcwM2FBwoWJIH_vMNzvsijIQaEoJuGZpRK43scdhwhQxF7E7PqXExfk9iTFg8DXhUg/exec',
                authToken: 'myAppToken2025'
            };
           
            try {
                const savedSettings = localStorage.getItem('appSettings');
                
                // If no saved settings, use defaults
                if (!savedSettings) {
                    return defaultSettings;
                }
                
                // Parse saved settings
                const parsedSettings = JSON.parse(savedSettings);
                
                // Verify if stored URL is a known problematic URL
                // If so, ignore localStorage and use the default
                if (parsedSettings.scriptUrl && 
                    (parsedSettings.scriptUrl.includes('AKfycbxksJAHHqDZ7E2VTp3TazcC4SOCOWef2oM2Tz5MY5Px--A7TUqNjIXeUev5J1QW-T0b') || 
                     parsedSettings.scriptUrl !== defaultSettings.scriptUrl)) {
                    console.log('⚠️ Found outdated script URL in localStorage. Using correct default URL instead.');
                    // Update localStorage with correct URL
                    localStorage.setItem('appSettings', JSON.stringify(defaultSettings));
                    return defaultSettings;
                }
                
                // Merge with defaults and return
                return { ...defaultSettings, ...parsedSettings };            } catch (error) {
                console.log('⚠️ localStorage not available or error occurred, using default settings:', error);
                return defaultSettings;
            }
        }

        // Calendar configuration - Updated with your actual fleet numbers
        const CALENDAR_IDS = [
            'noleggiosemplice23@gmail.com',
            'nijfu8k23bns6ml5rb0f7hko5o@group.calendar.google.com',
            'e48a242e31251e913222eec57efddba56d45e1efaa8346a95aa4c001699f4f5d@group.calendar.google.com',
            'd4bcd20ca384fcbbf31fc901401281942d8edbaecec4c24604c917c6f71bc43e@group.calendar.google.com',
            '8c2a425fa75bf5230dd2eee2a5cbedfcfa01279e943b5817efa25dfb359d8920@group.calendar.google.com',
            'aa19b3fbefcdee63ffa1b724e3a2f4c65ed49949db2e6cf3d40e13924daea94b@group.calendar.google.com',
            '6e36e87a89e5ef58137cf3c2475226dbb5c5a8aec3a60bce80e63fc72552f4b5@group.calendar.google.com',
            '9535c25ccd3adc5dc5a908aa9055cd8893e547657d6257f0a0232d50214c8c99@group.calendar.google.com',
            'a97fc8429fc9a143475e0244ad922ce0f6dfb025a88dd68baadd116ef4f0b5cc@group.calendar.google.com',
            '0e9a455f793914439c9ae0e5ef91790038aa8fc295e71cfacbc3b8f128def8fa@group.calendar.google.com'
        ];

        const CALENDAR_NAMES = [
            'Main Calendar',
            'N01 - Opel Vivaro (Losone)',
            'N03 - Peugeot Boxer (Bellinzona)',
            'N04 - Fiat Ducato (Locarno)',
            'N06 - Citroen Jumper (Minusio)',
            'N07 - Renault Trafic (Lugano)',
            'N08 - Renault Trafic (Lugano)',
            'N09 - Renault Trafic (Bellinzona)',
            'N10 - Citroen Jumper (Losone)',
            'N11 - Citroen Jumper (Losone)'
        ];

        const FLEET_NAMES = {
            0: 'Main Calendar',
            1: 'Van Fleet 1',
            2: 'Van Fleet 3',  // Skip 2 as mentioned
            3: 'Van Fleet 4'   // Continue sequence
        };        let currentDate = new Date();
        let currentEvents = [];
        let selectedEvent = null;
        let customerData = {};
        let dynamicCalendarNames = []; // Will be loaded from Google Calendar

        // Initialize calendar
        document.addEventListener('DOMContentLoaded', function() {
            // Check localStorage on load and make sure we have the correct script URL
            const settings = getSettings();
            console.log('🔧 Initialized with script URL:', settings.scriptUrl);
              // Initialize selected calendars first
            initializeSelectedCalendars();
            
            // Load calendar names first, then generate calendar and load data
            loadCalendarNames().then(() => {
                updateCalendarSelector(); // Initialize the calendar selector
                generateCalendar();
                loadCalendarData();
            });
           
            // Set up event listeners
            document.getElementById('calendarFilter').addEventListener('change', filterCalendarView);
            document.getElementById('dateRange').addEventListener('change', changeView);        });

        // Load calendar names dynamically from Google Calendar
        async function loadCalendarNames() {
            // Check if we already loaded the names
            if (dynamicCalendarNames.length > 0) {
                console.log('📅 Calendar names already loaded:', dynamicCalendarNames);
                return;
            }
            
            try {
                const settings = getSettings();
                
                // Check if settings are properly configured
                if (!settings.scriptUrl || !settings.authToken) {
                    console.warn('📅 Settings not configured properly, using static calendar names');                    dynamicCalendarNames = [...CALENDAR_NAMES];
                    updateCalendarDropdown();
                    updateCalendarLegend();
                    updateCalendarSelector();
                    return;
                }
                
                console.log('📅 Loading calendar names from Google Calendar...');
                
                // Try JSONP method first (more reliable for Google Apps Script)
                const jsonpUrl = `${settings.scriptUrl}?function=getCalendarNamesAppJsonp&authToken=${settings.authToken}`;
                
                try {
                    const jsonpData = await makeJsonpRequest(jsonpUrl, 10000); // 10 second timeout
                    
                    if (jsonpData && jsonpData.success && jsonpData.result && Array.isArray(jsonpData.result)) {
                        dynamicCalendarNames = ['Main Calendar', ...jsonpData.result.slice(1)];
                        
                        // Check if we have calendar color data too
                        if (jsonpData.calendars && Array.isArray(jsonpData.calendars)) {
                            window.dynamicCalendarData = jsonpData.calendars;
                            console.log('📅 Successfully loaded calendar names and colors via JSONP:', dynamicCalendarNames);
                            console.log('🎨 Calendar colors:', jsonpData.calendars.map(cal => cal.color));
                            updateDynamicColors(jsonpData.calendars);
                        } else {
                            console.log('📅 Successfully loaded calendar names via JSONP (no color data):', dynamicCalendarNames);
                        }                        
                        updateCalendarDropdown();
                        updateCalendarLegend();
                        updateCalendarSelector(); // Add calendar selector
                        return;
                    }
                } catch (jsonpError) {
                    console.warn('📅 JSONP method failed, trying fetch...', jsonpError);
                }
                
                // Fallback to fetch method
                const fetchUrl = `${settings.scriptUrl}?function=getCalendarNames&authToken=${settings.authToken}`;
                const response = await fetch(fetchUrl);
                const data = await response.json();
                
                if (data.result && Array.isArray(data.result)) {                    dynamicCalendarNames = ['Main Calendar', ...data.result.slice(1)];
                    console.log('📅 Successfully loaded calendar names via fetch:', dynamicCalendarNames);
                    updateCalendarDropdown();
                    updateCalendarLegend();
                    updateCalendarSelector();
                } else {
                    throw new Error('Invalid response format from fetch');
                }
                
            } catch (error) {                console.warn('📅 Could not load dynamic calendar names, using static fallback:', error);
                dynamicCalendarNames = [...CALENDAR_NAMES];
                updateCalendarDropdown();
                updateCalendarLegend();
                updateCalendarSelector();
            }
        }
        
        // Update colors dynamically if color data is available
        function updateDynamicColors(calendarData) {
            try {
                // Create dynamic CSS for event colors
                let dynamicCSS = '';
                calendarData.forEach((cal, index) => {
                    if (cal.color) {
                        dynamicCSS += `.event-pill.calendar-${index} { background: ${cal.color} !important; }\n`;
                    }
                });
                
                // Remove any existing dynamic color styles
                const existingStyle = document.getElementById('dynamic-calendar-colors');
                if (existingStyle) {
                    existingStyle.remove();
                }
                
                // Add new dynamic color styles
                const styleElement = document.createElement('style');
                styleElement.id = 'dynamic-calendar-colors';
                styleElement.textContent = dynamicCSS;
                document.head.appendChild(styleElement);
                
                console.log('🎨 Applied dynamic calendar colors');
            } catch (error) {
                console.warn('🎨 Failed to apply dynamic colors:', error);
            }
        }

        // Update calendar dropdown with dynamic names
        function updateCalendarDropdown() {
            const dropdown = document.getElementById('calendarFilter');
            // Clear existing options except "All Calendars"
            while (dropdown.children.length > 1) {
                dropdown.removeChild(dropdown.lastChild);
            }
            
            // Add dynamic calendar names
            dynamicCalendarNames.forEach((name, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = name;
                dropdown.appendChild(option);
            });
        }        // Update legend with dynamic names and colors
        function updateCalendarLegend() {
            const legendGrid = document.querySelector('.legend-grid');
            if (!legendGrid) return;
            
            legendGrid.innerHTML = '';
            
            // Default colors (fallback)
            const defaultColors = [
                '#667eea', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4',
                '#FECA57', '#FF9FF3', '#54A0FF', '#5F27CD', '#00D2D3'
            ];
            
            dynamicCalendarNames.forEach((name, index) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.style.cssText = 'display: flex; align-items: center; gap: 6px;';
                
                const colorSpan = document.createElement('span');
                colorSpan.className = 'legend-color';
                
                // Use dynamic color if available, otherwise use default
                let color = defaultColors[index] || '#ccc';
                if (window.dynamicCalendarData && window.dynamicCalendarData[index] && window.dynamicCalendarData[index].color) {
                    color = window.dynamicCalendarData[index].color;
                }
                
                colorSpan.style.cssText = `width: 12px; height: 12px; border-radius: 50%; background: ${color};`;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = name;
                
                legendItem.appendChild(colorSpan);
                legendItem.appendChild(nameSpan);
                legendGrid.appendChild(legendItem);
            });
        }

        // Create calendar selector checkboxes
        function updateCalendarSelector() {
            const selectorContainer = document.getElementById('calendarSelector');
            if (!selectorContainer) return;
            
            selectorContainer.innerHTML = '';
            
            const defaultColors = [
                '#667eea', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4',
                '#FECA57', '#FF9FF3', '#54A0FF', '#5F27CD', '#00D2D3'
            ];
            
            dynamicCalendarNames.forEach((name, index) => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'calendar-checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `calendar-${index}`;
                checkbox.value = index;
                checkbox.checked = selectedCalendars.has(index);
                
                const colorSpan = document.createElement('span');
                colorSpan.className = 'calendar-checkbox-color';
                
                // Use dynamic color if available, otherwise use default
                let color = defaultColors[index] || '#ccc';
                if (window.dynamicCalendarData && window.dynamicCalendarData[index] && window.dynamicCalendarData[index].color) {
                    color = window.dynamicCalendarData[index].color;
                }
                colorSpan.style.backgroundColor = color;
                
                const label = document.createElement('label');
                label.htmlFor = `calendar-${index}`;
                label.textContent = name;
                label.style.cursor = 'pointer';
                
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedCalendars.add(index);
                    } else {
                        selectedCalendars.delete(index);
                    }
                    renderEvents(); // Re-render events based on selection
                });
                
                checkboxItem.appendChild(checkbox);
                checkboxItem.appendChild(colorSpan);
                checkboxItem.appendChild(label);
                selectorContainer.appendChild(checkboxItem);
            });
        }

        function generateCalendar() {
            const calendar = document.getElementById('calendarView');
            const monthYear = document.getElementById('currentMonthYear');
           
            // Update month/year display
            const options = { year: 'numeric', month: 'long' };
            monthYear.textContent = currentDate.toLocaleDateString('en-US', options);
           
            // Clear calendar
            calendar.innerHTML = '';
           
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
           
            // Get first day of month and number of days
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
           
            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
               
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.onclick = () => selectDay(date);
               
                // Add classes for styling
                if (date.getMonth() !== currentDate.getMonth()) {
                    dayElement.classList.add('other-month');
                }
               
                if (isToday(date)) {
                    dayElement.classList.add('today');
                }
               
                // Day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = date.getDate();
                dayElement.appendChild(dayNumber);
               
                // Events container
                const eventsContainer = document.createElement('div');
                eventsContainer.className = 'day-events';
                dayElement.appendChild(eventsContainer);
               
                calendar.appendChild(dayElement);
            }
             renderEvents();
        }        function renderEvents() {
            const calendar = document.getElementById('calendarView');
            const days = calendar.querySelectorAll('.calendar-day');
            const filterValue = document.getElementById('calendarFilter').value;
           
            // Clear all existing events
            days.forEach(day => {
                const eventsContainer = day.querySelector('.day-events');
                if (eventsContainer) {
                    eventsContainer.innerHTML = '';
                }
            });
           
            // Filter events based on both dropdown filter AND checkbox selection
            let eventsToShow = currentEvents;
            
            // First apply dropdown filter
            if (filterValue !== 'all') {
                const calendarIndex = parseInt(filterValue);
                eventsToShow = eventsToShow.filter(event => {
                    const eventCalendarIndex = event.calendarIndex;
                    const eventCalendarName = event.calendarName;
                    const expectedCalendarName = dynamicCalendarNames[calendarIndex] || CALENDAR_NAMES[calendarIndex];
                    
                    return eventCalendarIndex === calendarIndex || 
                           eventCalendarName === expectedCalendarName ||
                           eventCalendarName === CALENDAR_NAMES[calendarIndex];
                });
            }
            
            // Then apply checkbox selection filter (only if checkboxes are being used)
            if (selectedCalendars.size > 0 && selectedCalendars.size < dynamicCalendarNames.length) {
                eventsToShow = eventsToShow.filter(event => {
                    return selectedCalendars.has(event.calendarIndex);
                });
            }
           
            // Group events by day for better layout
            const eventsByDay = {};
            eventsToShow.forEach(event => {
                const eventDate = new Date(event.start.date || event.start.dateTime);
                const dayKey = eventDate.toDateString();
                
                if (!eventsByDay[dayKey]) {
                    eventsByDay[dayKey] = [];
                }
                eventsByDay[dayKey].push(event);
            });
           
            // Render events grouped by day
            Object.keys(eventsByDay).forEach(dayKey => {
                const dayEvents = eventsByDay[dayKey];
                const eventDate = new Date(dayKey);
                const dayIndex = findDayIndex(eventDate);
               
                if (dayIndex >= 0 && dayIndex < days.length) {
                    const eventsContainer = days[dayIndex].querySelector('.day-events');
                    if (eventsContainer) {
                        // Limit number of visible events per day to avoid overflow
                        const maxEventsToShow = 4;
                        const eventsToRender = dayEvents.slice(0, maxEventsToShow);
                        
                        eventsToRender.forEach((event, index) => {
                            const eventPill = document.createElement('div');
                            
                            // Apply color based on time duration (Import Mails.js logic)
                            const eventColor = getEventColor(event);
                            eventPill.className = `event-pill calendar-${event.calendarIndex || 0}`;
                            eventPill.style.backgroundColor = eventColor;
                            
                            // Enhanced event title display
                            const eventTitle = event.summary || 'No title';
                            const calendarName = getCalendarDisplayName(event.calendarIndex);
                            
                            // Shorten title for better display
                            const displayTitle = eventTitle.length > 25 ? eventTitle.substring(0, 25) + '...' : eventTitle;
                            eventPill.textContent = displayTitle;
                            
                            // Enhanced tooltip with more information
                            const startTime = new Date(event.start.dateTime || event.start.date);
                            const endTime = new Date(event.end.dateTime || event.end.date);
                            const timeString = event.start.dateTime ? 
                                `${startTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${endTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` : 
                                'All day';
                            
                            eventPill.title = `${eventTitle}\n🚐 ${calendarName}\n⏰ ${timeString}`;
                            
                            eventPill.onclick = (e) => {
                                e.stopPropagation();
                                selectEvent(event);
                            };
                            
                            eventsContainer.appendChild(eventPill);
                        });
                        
                        // Show "more events" indicator if there are more events
                        if (dayEvents.length > maxEventsToShow) {
                            const moreIndicator = document.createElement('div');
                            moreIndicator.className = 'event-pill';
                            moreIndicator.style.cssText = 'background: #6c757d; font-style: italic; text-align: center;';
                            moreIndicator.textContent = `+${dayEvents.length - maxEventsToShow} more`;
                            moreIndicator.title = 'Click day to see all events';
                            eventsContainer.appendChild(moreIndicator);
                        }
                    }
                }
            });
            
            console.log(`Rendered ${eventsToShow.length} events (filtered: ${filterValue}, selected calendars: ${selectedCalendars.size})`);
        }
          // Helper function to get display name for calendar
        function getCalendarDisplayName(calendarIndex) {
            if (dynamicCalendarNames.length > 0 && dynamicCalendarNames[calendarIndex]) {
                return dynamicCalendarNames[calendarIndex];
            }
            if (CALENDAR_NAMES[calendarIndex]) {
                return CALENDAR_NAMES[calendarIndex];
            }
            return `Van ${calendarIndex}`;
        }

        function findDayIndex(date) {
            const calendar = document.getElementById('calendarView');
            const days = calendar.querySelectorAll('.calendar-day');
           
            for (let i = 7; i < days.length; i++) { // Skip header row
                const dayNumber = days[i].querySelector('.day-number');
                const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                dayDate.setDate(dayDate.getDate() - new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay() + i - 7);
               
                if (dayDate.toDateString() === date.toDateString()) {
                    return i;
                }
            }
            return -1;
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function navigateMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar();
            loadCalendarData();
        }

        function goToToday() {
            currentDate = new Date();
            generateCalendar();
            loadCalendarData();
        }

        function selectDay(date) {
            console.log('Selected day:', date);
        }

        // Enhanced event selection function
        function selectEvent(event) {
            const eventInfo = document.getElementById('eventInfo');
            const customerInfo = document.getElementById('customerInfo');
            
            // Display event details
            const startTime = new Date(event.start.dateTime || event.start.date);
            const endTime = new Date(event.end.dateTime || event.end.date);
            const calendarName = event.calendarName || CALENDAR_NAMES[event.calendarIndex] || 'Unknown Calendar';
            
            eventInfo.innerHTML = `
                <div class="event-detail-card" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #333; font-size: 16px;">${event.summary || 'No Title'}</h4>
                    <div class="event-meta" style="display: grid; gap: 8px; font-size: 13px; color: #666;">
                        <div><strong>📅 Date:</strong> ${startTime.toLocaleDateString()}</div>
                        <div><strong>⏰ Time:</strong> ${startTime.toLocaleTimeString()} - ${endTime.toLocaleTimeString()}</div>
                        <div><strong>🚐 Van:</strong> <span style="color: #333; font-weight: 500;">${calendarName}</span></div>
                        ${event.location ? `<div><strong>📍 Location:</strong> ${event.location}</div>` : ''}
                        ${event.description ? `<div><strong>📝 Notes:</strong> ${event.description}</div>` : ''}
                    </div>
                </div>
            `;
            
            // Extract customer information from event
            const customerName = extractCustomerName(event);
            const customerPhone = extractCustomerPhone(event);
            const customerEmail = extractCustomerEmail(event);
            
            if (customerName || customerPhone || customerEmail) {
                customerInfo.innerHTML = `
                    <div class="customer-card" style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <h4 style="margin: 0 0 10px 0; color: #1976d2; font-size: 16px;">👤 Customer Information</h4>
                        <div class="customer-details" style="font-size: 13px; color: #333; line-height: 1.4;">
                            ${customerName ? `<div><strong>Name:</strong> ${customerName}</div>` : ''}
                            ${customerPhone ? `<div><strong>Phone:</strong> <a href="tel:${customerPhone}" style="color: #1976d2;">${customerPhone}</a></div>` : ''}
                            ${customerEmail ? `<div><strong>Email:</strong> <a href="mailto:${customerEmail}" style="color: #1976d2;">${customerEmail}</a></div>` : ''}
                        </div>
                    </div>
                `;
            } else {
                customerInfo.innerHTML = `
                    <div style="padding: 15px; text-align: center; color: #666; font-size: 13px;">
                        No customer information available for this booking
                    </div>
                `;
            }
        }

        // Helper functions to extract customer data from events
        function extractCustomerName(event) {
            const title = event.summary || '';
            const description = event.description || '';
            
            // Try to extract name from title (common patterns)
            const nameMatch = title.match(/^([A-Za-z\s]+)\s*-/) || 
                             title.match(/([A-Za-z\s]+)\s*\(/) ||
                             description.match(/Nome?\s*:?\s*([A-Za-z\s]+)/i);
            
            return nameMatch ? nameMatch[1].trim() : null;
        }

        function extractCustomerPhone(event) {
            const text = (event.summary || '') + ' ' + (event.description || '');
            
            // Swiss/Italian phone number patterns
            const phoneMatch = text.match(/(?:\+41|0041)?\s*(?:\d{2}\s*\d{3}\s*\d{2}\s*\d{2})|(?:\d{3}\s*\d{3}\s*\d{2}\s*\d{2})|(?:\d{10})/);
            
            return phoneMatch ? phoneMatch[0].trim() : null;
        }

        function extractCustomerEmail(event) {
            const text = (event.summary || '') + ' ' + (event.description || '');
            
            const emailMatch = text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
            
            return emailMatch ? emailMatch[0] : null;
        }

        // =============================================================================
        // CRM SYSTEM FUNCTIONALITY
        // =============================================================================
        
        let crmSpreadsheetUrl = '';
          // JSONP helper function for API calls with configurable timeout
        function makeJsonpRequest(url, timeoutMs = 90000) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                    resolve(data);
                };
                
                const script = document.createElement('script');
                script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
                script.onerror = function() {
                    delete window[callbackName];
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                    reject(new Error('JSONP request failed - network or script error'));
                };
                
                document.body.appendChild(script);
                
                // Configurable timeout
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        if (document.body.contains(script)) {
                            document.body.removeChild(script);
                        }
                        reject(new Error(`Request timed out after ${timeoutMs/1000} seconds`));
                    }
                }, timeoutMs);
            });
        }
        
        // Initialize CRM functionality
        document.addEventListener('DOMContentLoaded', function() {
            const buildCrmBtn = document.getElementById('buildCrmBtn');
            const buildQuickCrmBtn = document.getElementById('buildQuickCrmBtn');
            const openCrmSpreadsheetBtn = document.getElementById('openCrmSpreadsheetBtn');
            const crmStatus = document.getElementById('crmStatus');
            const crmAnalytics = document.getElementById('crmAnalytics');
            
            // Quick CRM Database (3 months)
            buildQuickCrmBtn.addEventListener('click', async function() {
                try {
                    // Show loading state
                    buildQuickCrmBtn.disabled = true;
                    buildQuickCrmBtn.style.background = '#6c757d';
                    buildQuickCrmBtn.innerHTML = '⏳ Quick Processing...';
                    
                    crmStatus.style.display = 'block';
                    crmStatus.style.background = '#e3f2fd';
                    crmStatus.innerHTML = '⚡ Starting quick CRM analysis...<br><small>Processing last 3 months of data for fast results.</small>';
                    
                    crmAnalytics.style.display = 'none';
                    
                    const settings = getSettings();
                    const url = `${settings.scriptUrl}?function=buildQuickCustomerCRMDatabaseJsonp&authToken=${settings.authToken}`;
                    
                    crmStatus.innerHTML = '📡 Connecting to Google Apps Script...<br><small>Quick analysis of recent calendar events...</small>';
                    
                    const data = await makeJsonpRequest(url, 45000); // Shorter timeout for quick mode
                    
                    if (data.success) {
                        // Success state
                        crmStatus.style.background = '#d4edda';
                        crmStatus.innerHTML = `✅ Quick CRM analysis completed!<br><small>Found ${data.totalCustomers} customers and ${data.totalBookings} bookings (${data.dataScope})</small>`;
                        
                        // Show analytics
                        crmAnalytics.style.display = 'block';
                        document.getElementById('totalCustomers').textContent = data.totalCustomers;
                        document.getElementById('totalBookings').textContent = data.totalBookings;
                        
                        // Generate insights
                        const insights = generateCrmInsights(data);
                        document.getElementById('crmInsightsList').innerHTML = `<strong>💡 Key Insights (${data.dataScope}):</strong><br>${insights.join('<br>')}`;
                        
                        // Enable spreadsheet button
                        crmSpreadsheetUrl = data.spreadsheetUrl;
                        openCrmSpreadsheetBtn.disabled = false;
                        openCrmSpreadsheetBtn.style.background = '#34a853';
                        
                        // Auto-hide status after 5 seconds
                        setTimeout(() => {
                            crmStatus.style.display = 'none';
                        }, 5000);
                        
                    } else {
                        // Error state
                        crmStatus.style.background = '#f8d7da';
                        crmStatus.innerHTML = `❌ Failed to build quick CRM<br><small>Error: ${data.error}</small>`;
                    }
                    
                } catch (error) {
                    crmStatus.style.background = '#f8d7da';
                    crmStatus.innerHTML = `❌ Error in quick CRM analysis<br><small>Error: ${error.message}</small>`;
                } finally {
                    // Reset button
                    buildQuickCrmBtn.disabled = false;
                    buildQuickCrmBtn.style.background = '#34a853';
                    buildQuickCrmBtn.innerHTML = '⚡ Quick CRM (3 months)';
                }
            });

            // Build CRM Database
            buildCrmBtn.addEventListener('click', async function() {
                try {
                    // Show loading state
                    buildCrmBtn.disabled = true;
                    buildCrmBtn.style.background = '#6c757d';
                    buildCrmBtn.innerHTML = '⏳ Building Database...';
                    
                    crmStatus.style.display = 'block';
                    crmStatus.style.background = '#e3f2fd';
                    crmStatus.innerHTML = '🚀 Starting CRM database creation...<br><small>This may take a few minutes as we analyze all your calendar events.</small>';
                    
                    crmAnalytics.style.display = 'none';
                    
                    const settings = getSettings();
                    const url = `${settings.scriptUrl}?function=buildCustomerCRMDatabaseJsonp&authToken=${settings.authToken}`;
                    
                    crmStatus.innerHTML = '📡 Connecting to Google Apps Script...<br><small>Analyzing calendar events from all vans...</small>';
                    
                    const data = await makeJsonpRequest(url);
                    
                    if (data.success) {
                        // Success state
                        crmStatus.style.background = '#d4edda';
                        crmStatus.innerHTML = `✅ CRM Database created successfully!<br><small>Found ${data.totalCustomers} customers and ${data.totalBookings} bookings</small>`;
                        
                        // Show analytics
                        crmAnalytics.style.display = 'block';
                        document.getElementById('totalCustomers').textContent = data.totalCustomers;
                        document.getElementById('totalBookings').textContent = data.totalBookings;
                        
                        // Generate insights
                        const insights = generateCrmInsights(data);
                        document.getElementById('crmInsightsList').innerHTML = `<strong>💡 Key Insights:</strong><br>${insights.join('<br>')}`;
                        
                        // Enable spreadsheet button
                        crmSpreadsheetUrl = data.spreadsheetUrl;
                        openCrmSpreadsheetBtn.disabled = false;
                        openCrmSpreadsheetBtn.style.background = '#34a853';
                        
                        // Auto-hide status after 5 seconds
                        setTimeout(() => {
                            crmStatus.style.display = 'none';
                        }, 5000);
                        
                    } else {
                        // Error state
                        crmStatus.style.background = '#f8d7da';
                        crmStatus.innerHTML = `❌ Failed to build CRM database<br><small>Error: ${data.error}</small>`;
                    }
                    
                } catch (error) {
                    crmStatus.style.background = '#f8d7da';
                    crmStatus.innerHTML = `❌ Error building CRM database<br><small>Error: ${error.message}</small>`;
                } finally {
                    // Reset button
                    buildCrmBtn.disabled = false;
                    buildCrmBtn.style.background = '#4285f4';
                    buildCrmBtn.innerHTML = '📊 Build Complete CRM Database';
                }
            });
            
            // Open CRM Spreadsheet
            openCrmSpreadsheetBtn.addEventListener('click', function() {
                if (crmSpreadsheetUrl) {
                    window.open(crmSpreadsheetUrl, '_blank');
                } else {
                    alert('Please build the CRM database first');
                }
            });
            
            function generateCrmInsights(data) {
                const insights = [];
                
                if (data.totalCustomers > 0) {
                    const avgBookingsPerCustomer = Math.round(data.totalBookings / data.totalCustomers * 10) / 10;
                    insights.push(`📊 ${avgBookingsPerCustomer} avg bookings per customer`);
                }
                
                insights.push('🎯 Customer segments: New, Repeat, Loyal, VIP');
                insights.push('📅 Seasonal patterns & preferred van analysis');
                insights.push('📋 Complete booking history exported to Sheets');
                
                return insights;
            }
        });
        
        // Enhanced customer display for selected events
        function displayCustomerCRM(customerName) {
            if (!customerName) {
                document.getElementById('customerInfo').innerHTML = `
                    <div class="no-event">
                        Select a booking to view customer data<br>
                        <small style="color: #666;">Or build the CRM database for complete analytics</small>
                    </div>
                `;
                return;
            }
            
            // Mock customer data for immediate display (will be replaced by real CRM data)
            const mockCustomerData = {
                totalRentals: Math.floor(Math.random() * 10) + 1,
                totalSpent: Math.floor(Math.random() * 5000) + 500,
                favoriteVan: ['N01', 'N03', 'N04', 'N06', 'N07'][Math.floor(Math.random() * 5)],
                lastRental: '2024-11-15',
                segment: ['New', 'Repeat', 'Loyal', 'VIP'][Math.floor(Math.random() * 4)]
            };

            const customerInfo = document.getElementById('customerInfo');
            customerInfo.innerHTML = `
                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <strong style="color: #333;">${customerName}</strong>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                        <span style="background: #007cba; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">${mockCustomerData.segment}</span>
                    </div>
                </div>
               
                <div class="crm-stats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;">
                    <div class="stat-card" style="background: #e3f2fd; padding: 10px; border-radius: 6px; text-align: center;">
                        <div class="stat-value" style="font-size: 18px; font-weight: bold; color: #1976d2;">${mockCustomerData.totalRentals}</div>
                        <div class="stat-label" style="font-size: 11px; color: #666;">Rentals</div>
                    </div>
                    <div class="stat-card" style="background: #e8f5e8; padding: 10px; border-radius: 6px; text-align: center;">
                        <div class="stat-value" style="font-size: 18px; font-weight: bold; color: #2e7d32;">CHF ${mockCustomerData.totalSpent}</div>
                        <div class="stat-label" style="font-size: 11px; color: #666;">Revenue</div>
                    </div>
                </div>
               
                <div class="rental-history" style="font-size: 13px;">
                    <strong style="color: #333;">📅 Recent Activity:</strong>
                    <div style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 6px;">
                        <div style="color: #856404;">Last rental: ${mockCustomerData.lastRental}</div>
                        <div style="color: #856404; font-size: 12px;">Preferred van: ${mockCustomerData.favoriteVan}</div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 8px; background: #d1ecf1; border-radius: 6px; font-size: 12px; color: #0c5460;">
                    💡 <strong>Tip:</strong> Build the complete CRM database above for detailed customer analytics and insights.
                </div>
            `;
        }
        // Color system matching your Import Mails.js logic
        const EVENT_COLORS = {
            FULL_DAY: '#FF6B6B',      // Red - 7:00-19:00 (Color "11")
            MORNING: '#96CEB4',       // Green - Morning half day (Color "10") 
            AFTERNOON: '#FECA57',     // Orange - Afternoon half day (Color "5")
            DEFAULT: '#667eea'        // Blue - Default for other times
        };

        let selectedCalendars = new Set(); // Track which calendars are selected for display

        // Initialize with all calendars selected
        function initializeSelectedCalendars() {
            selectedCalendars.clear();
            for (let i = 0; i < CALENDAR_NAMES.length; i++) {
                selectedCalendars.add(i);
            }
        }

        // Get event color based on time (matching Import Mails.js logic)
        function getEventColor(event) {
            if (!event.start.dateTime || !event.end.dateTime) {
                return EVENT_COLORS.DEFAULT;
            }

            const startTime = new Date(event.start.dateTime);
            const endTime = new Date(event.end.dateTime);
            const startHour = startTime.getHours();
            const endHour = endTime.getHours();

            // Full day: 7:00-19:00
            if (startHour === 7 && endHour === 19) {
                return EVENT_COLORS.FULL_DAY; // Red
            }
            // Morning half day: 7:00-12:00 or 1:00-12:00
            else if ((startHour === 7 && endHour === 12) || (startHour === 1 && endHour === 12)) {
                return EVENT_COLORS.MORNING; // Green
            }
            // Afternoon half day: 13:00-19:00, 13:00-0:00, or 20:00-0:00
            else if ((startHour === 13 && endHour === 19) || 
                     (startHour === 13 && endHour === 0) || 
                     (startHour === 20 && endHour === 0)) {
                return EVENT_COLORS.AFTERNOON; // Orange
            }
            
            return EVENT_COLORS.DEFAULT; // Blue for other times
        }
        async function loadCalendarData() {
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshIcon = document.getElementById('refreshIcon');
           
            refreshBtn.disabled = true;
            refreshIcon.innerHTML = '<span class="loading"></span>';
           
            try {
                const settings = getSettings();
               
                // Calculate date range for current month view
                const startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
               
                // Format dates for API
                const startDateStr = startDate.toISOString().split('T')[0];
                const endDateStr = endDate.toISOString().split('T')[0];
               
                console.log('🔄 Loading calendar data for:', startDateStr, 'to', endDateStr);
                console.log('📡 Using script URL:', settings.scriptUrl);
               
                // Add timestamp to prevent caching issues
                const timestamp = Date.now();
                  // Call Google Apps Script to fetch calendar events using JSONP
                const requestUrl = `${settings.scriptUrl}?function=getCalendarEventsAppJsonp&authToken=${settings.authToken}&startDate=${startDateStr}&endDate=${endDateStr}&timestamp=${timestamp}`;
               
                const data = await makeJsonpRequest(requestUrl);
                console.log('� JSONP Response received');
                 if (data.result && Array.isArray(data.result)) {
                    currentEvents = data.result;
                    renderEvents();
                    console.log('✅ Calendar events loaded successfully:', currentEvents.length, 'events');
                } else if (data.error) {
                    throw new Error('API Error: ' + data.error);
                } else {
                    throw new Error('Invalid response format');
                }
               
            } catch (error) {
                console.error('❌ Error loading calendar data:', error);
               
                const vans = ['Van A', 'Van B', 'Van C', 'Van D'];
               
                events.push({
                    id: `event_${i}`,
                    summary: `${customers[Math.floor(Math.random() * customers.length)]} - ${vans[Math.floor(Math.random() * vans.length)]}`,
                    start: { dateTime: startDate.toISOString() },
                    end: { dateTime: endDate.toISOString() },
                    location: 'Pickup Location',
                    description: 'Van rental booking',
                    calendarIndex: Math.floor(Math.random() * 4)
                });
            }           
            return events;
        }
        
        function filterCalendarView() {
            const filterValue = document.getElementById('calendarFilter').value;
            
            // If "all" is selected, show all events
            if (filterValue === 'all') {
                renderEvents();
                return;
            }
              // Filter events by calendar index
            const calendarIndex = parseInt(filterValue);
            const filteredEvents = currentEvents.filter(event => 
                event.calendarIndex === calendarIndex || 
                event.calendarName === (dynamicCalendarNames[calendarIndex] || CALENDAR_NAMES[calendarIndex])
            );
            
            // Temporarily store original events and render filtered ones
            const originalEvents = currentEvents;
            currentEvents = filteredEvents;
            renderEvents();
            currentEvents = originalEvents; // Restore original events
            
            console.log(`Filtered to show ${CALENDAR_NAMES[calendarIndex] || 'Unknown'} calendar events:`, filteredEvents.length);
        }        function changeView() {
            const view = document.getElementById('dateRange').value;
            // Implement view change logic (month/week/day)
            console.log('Changed to view:', view);
        }

        // =============================================================================
        // TAB SYSTEM FUNCTIONALITY
        // =============================================================================

        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            const selectedTab = document.getElementById(`${tabName}-tab`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Activate corresponding button
            const selectedButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }

            // Load specific data based on tab
            if (tabName === 'dashboard') {
                loadDashboardData();
            }

            console.log(`Switched to ${tabName} tab`);
        }

        // =============================================================================
        // DASHBOARD FUNCTIONALITY
        // =============================================================================

        function loadDashboardData() {
            loadTodaySchedule();
            loadCustomerRatings();
            loadBestCustomers('total');
            loadVanUtilization();
        }

        function loadTodaySchedule() {
            const scheduleContainer = document.getElementById('todaySchedule');
            const today = new Date();
            const todayStr = today.toDateString();

            // Filter today's events
            const todaysEvents = currentEvents.filter(event => {
                const eventDate = new Date(event.start.date || event.start.dateTime);
                return eventDate.toDateString() === todayStr;
            });

            if (todaysEvents.length === 0) {
                scheduleContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px;">
                        No van rentals scheduled for today
                    </div>
                `;
                return;
            }

            let scheduleHTML = '';
            todaysEvents.forEach(event => {
                const startTime = new Date(event.start.dateTime || event.start.date);
                const endTime = new Date(event.end.dateTime || event.end.date);
                const calendarName = getCalendarDisplayName(event.calendarIndex);
                const customerName = extractCustomerName(event) || 'Customer';
                
                const timeDisplay = event.start.dateTime ? 
                    `${startTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${endTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` : 
                    'All Day';

                scheduleHTML += `
                    <div style="border-left: 4px solid ${getEventColor(event)}; padding: 10px 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 0 8px 8px 0;">
                        <div style="font-weight: 600; color: #333;">${customerName}</div>
                        <div style="font-size: 12px; color: #666; margin: 4px 0;">
                            🚐 ${calendarName} | ⏰ ${timeDisplay}
                        </div>
                        <div style="font-size: 11px; color: #888;">${event.summary || 'No details'}</div>
                    </div>
                `;
            });

            scheduleContainer.innerHTML = scheduleHTML;
        }

        function loadCustomerRatings() {
            const ratingsContainer = document.getElementById('customerRatings');
            
            // Mock customer ratings data (in real implementation, this would come from CRM)
            const mockRatings = [
                { name: 'Marco Rossi', rating: 5, rentals: 8 },
                { name: 'Anna Bianchi', rating: 5, rentals: 12 },
                { name: 'Giuseppe Verde', rating: 4, rentals: 5 },
                { name: 'Maria Neri', rating: 5, rentals: 15 },
                { name: 'Luca Gialli', rating: 4, rentals: 3 }
            ];

            let ratingsHTML = '';
            mockRatings.forEach(customer => {
                const stars = '★'.repeat(customer.rating) + '☆'.repeat(5 - customer.rating);
                ratingsHTML += `
                    <div class="customer-rating">
                        <div>
                            <div style="font-weight: 500;">${customer.name}</div>
                            <div style="font-size: 11px; color: #666;">${customer.rentals} rentals</div>
                        </div>
                        <div class="rating-stars">${stars}</div>
                    </div>
                `;
            });

            ratingsContainer.innerHTML = ratingsHTML;
        }

        function loadBestCustomers(period) {
            // Update active button
            document.querySelectorAll('.stats-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="showStats('${period}')"]`).classList.add('active');

            const customersContainer = document.getElementById('bestCustomers');
            
            // Mock data based on period
            let customers = [];
            switch(period) {
                case 'total':
                    customers = [
                        { name: 'Maria Neri', revenue: 'CHF 2,850', rentals: 15 },
                        { name: 'Anna Bianchi', revenue: 'CHF 2,220', rentals: 12 },
                        { name: 'Franco Blu', revenue: 'CHF 1,980', rentals: 11 },
                        { name: 'Marco Rossi', revenue: 'CHF 1,480', rentals: 8 }
                    ];
                    break;
                case 'ytd':
                    customers = [
                        { name: 'Anna Bianchi', revenue: 'CHF 1,850', rentals: 10 },
                        { name: 'Maria Neri', revenue: 'CHF 1,650', rentals: 9 },
                        { name: 'Franco Blu', revenue: 'CHF 1,350', rentals: 7 },
                        { name: 'Giuseppe Verde', revenue: 'CHF 925', rentals: 5 }
                    ];
                    break;
                case 'month':
                    customers = [
                        { name: 'Marco Rossi', revenue: 'CHF 555', rentals: 3 },
                        { name: 'Anna Bianchi', revenue: 'CHF 370', rentals: 2 },
                        { name: 'Luca Gialli', revenue: 'CHF 185', rentals: 1 }
                    ];
                    break;
            }

            let customersHTML = '';
            customers.forEach((customer, index) => {
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '👤';
                customersHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f2f5;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>${medal}</span>
                            <div>
                                <div style="font-weight: 500;">${customer.name}</div>
                                <div style="font-size: 11px; color: #666;">${customer.rentals} rentals</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: #2e7d32;">${customer.revenue}</div>
                        </div>
                    </div>
                `;
            });

            customersContainer.innerHTML = customersHTML;
        }

        function showStats(period) {
            loadBestCustomers(period);
        }

        function loadVanUtilization() {
            // This would normally calculate from actual booking data
            // For now, showing mock data that updates based on current events
            const utilizationContainer = document.getElementById('vanUtilization');
            
            const vanData = [
                { name: 'N01 - Opel Vivaro', utilization: 85 },
                { name: 'N03 - Peugeot Boxer', utilization: 72 },
                { name: 'N04 - Fiat Ducato', utilization: 91 },
                { name: 'N06 - Citroen Jumper', utilization: 68 },
                { name: 'N07 - Renault Trafic', utilization: 79 }
            ];

            let utilizationHTML = '';
            vanData.forEach(van => {
                const color = van.utilization > 80 ? '#4caf50' : van.utilization > 60 ? '#ff9800' : '#f44336';
                utilizationHTML += `
                    <div class="utilization-item" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-size: 12px;">${van.name}</span>
                            <span style="font-weight: 600;">${van.utilization}%</span>
                        </div>
                        <div class="utilization-bar">
                            <div class="utilization-fill" style="width: ${van.utilization}%; background: ${color};"></div>
                        </div>
                    </div>
                `;
            });

            utilizationContainer.innerHTML = utilizationHTML;
        }

        // =============================================================================
        // CRM ACTION FUNCTIONS
        // =============================================================================

        function buildCRMDatabase() {
            alert('Building CRM Database... This will analyze all calendar events and create customer profiles.');
            // This would integrate with the existing CRM functionality
        }

        function exportCustomerList() {
            alert('Exporting customer list... This will create a CSV file with all customer data.');
        }

        function generateReports() {
            alert('Generating reports... This will create monthly and annual reports.');
        }

        function openCrmSpreadsheet() {
            alert('Opening CRM Spreadsheet... This will open the Google Sheets with customer data.');
        }

        // Auto-focus on calendar
        document.getElementById('calendarView').focus();
    </script>
</body>
</html>
