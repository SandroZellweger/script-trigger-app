<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expenses</title>
    <style>
        .hidden { display: none; }
        .form-section { margin-top: 20px; }
        .error { color: red; }
        .success { color: green; }
        button { cursor: pointer; }
    </style>
</head>
<body>
    <div>
        <a href="index.html">â†</a>
    </div>

    <div>
        <h1>ğŸ’° Expenses</h1>
        <p>Track and manage business expenses</p>
    </div>

    <div>
        <div>
            <p><strong>CHF 0</strong></p>
            <p>Total Expenses</p>
        </div>
        <div>
            <p><strong>CHF 0</strong></p>
            <p>This Month</p>
        </div>
        <div>
            <p><strong>0</strong></p>
            <p>Total Entries</p>
        </div>
    </div>

    <div>
        <button onclick="toggleForm()">â• New Expense</button>
        <p>Log a new expense with receipt</p>
        <a href="#past-expenses">ğŸ“‹ View Expenses</a>
        <p>See and manage past expenses</p>
    </div>

    <div id="expense-form" class="form-section hidden">
        <h2>ğŸ’° New Expense</h2>
        <form id="new-expense-form">
            <label>Date of Purchase:</label>
            <input type="date" name="date" required><br>

            <label>Payment Method:</label>
            <input type="radio" name="payment_method" value="Cash" required> Cash
            <input type="radio" name="payment_method" value="Card"> Card<br>

            <label>Paid By:</label>
            <select name="paid_by" required>
                <option value="Company">Company</option>
                <option value="Private Sandro">Private Sandro</option>
                <option value="Private Alessandro">Private Alessandro</option>
            </select><br>

            <label>Category:</label>
            <select name="category" required>
                <option value="Fuel">Fuel</option>
                <option value="Maintenance">Maintenance</option>
                <option value="Parking">Parking</option>
                <option value="Tolls">Tolls</option>
                <option value="Insurance">Insurance</option>
                <option value="Other">Other</option>
            </select><br>

            <label>Amount (CHF):</label>
            <input type="number" name="amount" step="0.01" min="0" required><br>

            <label>Vehicle:</label>
            <select name="vehicle">
                <option value="All">All</option>
                <option value="N1">N1</option>
                <option value="N2">N2</option>
                <option value="N3">N3</option>
                <option value="N4">N4</option>
                <option value="N5">N5</option>
                <option value="N6">N6</option>
                <option value="N7">N7</option>
                <option value="N8">N8</option>
                <option value="N9">N9</option>
                <option value="N10">N10</option>
                <option value="N11">N11</option>
                <option value="None">None</option>
            </select><br>

            <label>Profiteur:</label>
            <select name="profiteur">
                <option value="Sandro">Sandro</option>
                <option value="Alessandro">Alessandro</option>
                <option value="None">None</option>
            </select><br>

            <label>Receipt Photo (Optional):</label>
            <input type="file" name="receipt" accept="image/*" disabled>
            <p>Note: Image uploads are temporarily disabled due to technical limitations.</p>

            <button type="submit">Submit Expense</button>
            <button type="button" onclick="cancelForm()">Cancel</button>
        </form>
        <p id="form-message"></p>
    </div>

    <div id="past-expenses">
        <h2>ğŸ“‹ Past Expenses</h2>
        <p>No expenses yet</p>
    </div>

    <div>
        <h2>ğŸ“Š Activity Log</h2>
        <p>No activity yet</p>
        <button>Clear Logs</button>
    </div>

   <script>
    function toggleForm() {
        const form = document.getElementById('expense-form');
        form.classList.toggle('hidden');
        if (!form.classList.contains('hidden')) {
            document.getElementById('new-expense-form').reset();
            document.getElementById('form-message').textContent = '';
        }
    }

    function cancelForm() {
        document.getElementById('new-expense-form').reset();
        document.getElementById('expense-form').classList.add('hidden');
        document.getElementById('form-message').textContent = '';
    }

    document.getElementById('new-expense-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const message = document.getElementById('form-message');
        message.textContent = 'Submitting...';

        // Basic client-side validation
        const amount = form.amount.value;
        if (amount <= 0) {
            message.textContent = 'Error: Amount must be greater than 0';
            message.className = 'error';
            return;
        }

        // Prepare form data
        const formData = new FormData(form);
        const data = {
            function: 'logExpense', // Required by doPost
            authToken: localStorage.getItem('authToken') || 'myAppToken2025', // From settings or hardcoded
            date: formData.get('date'),
            method: formData.get('payment_method'),
            paidBy: formData.get('paid_by'),
            category: formData.get('category'),
            amount: parseFloat(formData.get('amount')),
            vehicle: formData.get('vehicle'),
            profiteur: formData.get('profiteur'),
            image: '', // Image uploads disabled
            imageName: '' // Image uploads disabled
        };

        try {
            // Retrieve script URL from settings (or use deployed URL)
            const scriptUrl = localStorage.getItem('scriptUrl') || 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
            const response = await fetch(scriptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.result) {
                message.textContent = 'Expense submitted successfully!';
                message.className = 'success';
                form.reset();
                setTimeout(() => {
                    document.getElementById('expense-form').classList.add('hidden');
                    message.textContent = '';
                    // Optionally, refresh past expenses
                    fetchPastExpenses();
                }, 2000);
            } else {
                message.textContent = `Error: ${result.error || 'Failed to submit expense'}`;
                message.className = 'error';
            }
        } catch (err) {
            message.textContent = `Error: ${err.message}`;
            message.className = 'error';
        }
    });

    // Function to fetch and display past expenses
    async function fetchPastExpenses() {
        try {
            const scriptUrl = localStorage.getItem('scriptUrl') || 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
            const response = await fetch(`${scriptUrl}?function=getExpenses&authToken=${encodeURIComponent(localStorage.getItem('authToken') || 'myAppToken2025')}`);
            const result = await response.json();

            const pastExpensesDiv = document.getElementById('past-expenses');
            if (result.result && result.result.length > 0) {
                const expenses = result.result;
                let html = '<h2>ğŸ“‹ Past Expenses</h2><ul>';
                expenses.forEach(expense => {
                    html += `<li>${expense.date} - ${expense.category} - CHF ${expense.amount} (${expense.paidBy})</li>`;
                });
                html += '</ul>';
                pastExpensesDiv.innerHTML = html;
            } else {
                pastExpensesDiv.innerHTML = '<h2>ğŸ“‹ Past Expenses</h2><p>No expenses yet</p>';
            }
        } catch (err) {
            console.error('Failed to fetch expenses:', err);
        }
    }

    // Fetch past expenses on page load
    window.onload = fetchPastExpenses;
</script>
</body>
</html>
