<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Calendar & CRM">
    <title>Calendar & CRM - Van Rentals</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #7DBB35 0%, #5a8827 100%);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 10px 15px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: white;
            transform: translateY(-2px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #333;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        /* Tab System */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            padding-bottom: 10px;
        }

        .tab-btn {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #333;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .tab-btn.active {
            background: #4285f4;
            color: white;
            box-shadow: 0 4px 12px rgba(66,133,244,0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 12px;
            font-weight: 500;
            color: #666;
        }

        .control-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .calendar-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            margin-top: 5px;
        }

        .calendar-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            border: 1px solid #e1e5e9;
            transition: all 0.2s ease;
        }

        .calendar-checkbox-item:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .calendar-checkbox-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .calendar-checkbox-item label {
            font-size: 12px;
            color: #333;
            cursor: pointer;
            margin: 0;
            flex-grow: 1;
            user-select: none;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .calendar-section {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .nav-btn {
            background: #4285f4;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #3367d6;
            transform: scale(1.1);
        }

        .month-year {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e1e5e9;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: #f8f9fa;
            padding: 10px 5px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            color: #666;
        }

        .calendar-day {
            background: white;
            min-height: 110px;
            padding: 6px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
        }

        .calendar-day:hover {
            background: #f0f8ff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .calendar-day.today {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid #667eea;
        }

        .day-number {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
            text-align: center;
            flex-shrink: 0;
        }

        .day-events {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex-grow: 1;
            overflow: hidden;
        }

        .event-pill {
            color: white;
            font-size: 9px;
            padding: 3px 6px;
            border-radius: 12px;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            line-height: 1.2;
            min-height: 16px;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .event-pill:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 10;
            position: relative;
        }

        /* Event Colors (Time-based) */
        .event-pill.full-day { background: #FF6B6B; } /* Red - Full Day */
        .event-pill.morning { background: #96CEB4; } /* Green - Morning */
        .event-pill.afternoon { background: #FECA57; } /* Orange - Afternoon */
        .event-pill.default { background: #667eea; } /* Blue - Default */

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .event-details, .customer-info {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .event-details h3, .customer-info h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .no-event {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        /* Van Legend */
        .van-legend {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .van-legend h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .dashboard-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .dashboard-card h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .stats-toggle {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .stats-btn {
            background: #f0f2f5;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .stats-btn:hover {
            background: #e4e6ea;
        }

        .stats-btn.active {
            background: #4285f4;
            color: white;
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }

        .customer-rating {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f2f5;
        }

        .customer-rating:last-child {
            border-bottom: none;
        }

        .rating-stars {
            color: #ffc107;
        }

        .revenue-item, .utilization-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }

        .metric-value {
            font-weight: 600;
            color: #2e7d32;
        }

        .utilization-bar {
            width: 100%;
            height: 8px;
            background: #f0f2f5;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }

        .utilization-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.3s ease;
        }

        /* Responsive Design */
        @media screen and (max-width: 1100px) {
            .calendar-grid {
                grid-template-columns: 1fr 300px;
            }
        }

        @media screen and (max-width: 900px) {
            .calendar-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-day {
                min-height: 80px;
                padding: 4px;
            }
            
            .event-pill {
                font-size: 8px;
                padding: 2px 4px;
                min-height: 14px;
            }
        }

        @media screen and (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .calendar-selector {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .animate-in {
            animation: slideInUp 0.6s ease forwards;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-button">
        <span>←</span>
        Back to Home
    </a>

    <div class="container">
        <div class="header animate-in">
            <h1>📅 Van Rental Calendar & CRM</h1>
            <p>Manage bookings and customer relationships</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation animate-in">
            <button class="tab-btn active" onclick="switchTab('calendar')">
                📅 Calendar View
            </button>
            <button class="tab-btn" onclick="switchTab('dashboard')">
                📊 CRM Dashboard
            </button>
        </div>

        <!-- Calendar Tab -->
        <div id="calendar-tab" class="tab-content active">
            <div class="controls animate-in">
                <div class="control-group">
                    <label for="calendarFilter">View Calendar:</label>
                    <select id="calendarFilter">
                        <option value="all">All Calendars</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Select Vans:</label>
                    <div class="calendar-selector" id="calendarSelector">
                        <!-- Dynamic checkboxes will be populated here -->
                    </div>
                </div>
                
                <button class="refresh-btn" id="refreshBtn" onclick="loadCalendarData()">
                    <span id="refreshIcon">🔄</span>
                    Refresh Data
                </button>
            </div>

            <div class="calendar-grid">
                <div class="calendar-section animate-in">
                    <div class="calendar-header">
                        <button class="nav-btn" onclick="navigateMonth(-1)" title="Previous Month">◀</button>
                        <h2 id="currentMonthYear" class="month-year">June 2025</h2>
                        <button class="nav-btn" onclick="navigateMonth(1)" title="Next Month">▶</button>
                        <button class="nav-btn" onclick="goToToday()" title="Go to Today">📍</button>
                    </div>
                   
                    <div class="calendar-view" id="calendarView">
                        <!-- Calendar will be generated here -->
                    </div>
                </div>

                <div class="sidebar">
                    <div class="event-details animate-in">
                        <h3>📋 Event Details</h3>
                        <div id="eventInfo" class="no-event">
                            Click on any booking to view details
                        </div>
                    </div>

                    <div class="customer-info animate-in">
                        <h3>👤 Customer Info</h3>
                        <div id="customerInfo" class="no-event">
                            Select a booking to view customer information
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Van Fleet Legend -->
            <div class="van-legend animate-in">
                <h3>🚐 Van Fleet</h3>
                <div class="legend-grid" id="vanLegend">
                    <!-- Dynamic legend will be populated here -->
                </div>
            </div>
        </div>

        <!-- CRM Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div class="dashboard-grid">
                <!-- Today's Schedule -->
                <div class="dashboard-card animate-in">
                    <h3>📅 Today's Schedule</h3>
                    <div id="todaySchedule" class="schedule-container">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            Loading today's van schedule...
                        </div>
                    </div>
                </div>

                <!-- Customer Ratings -->
                <div class="dashboard-card animate-in">
                    <h3>⭐ Customer Ratings</h3>
                    <div id="customerRatings" class="ratings-container">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            Loading customer ratings...
                        </div>
                    </div>
                </div>

                <!-- Best Customers -->
                <div class="dashboard-card animate-in">
                    <h3>🏆 Best Customers</h3>
                    <div class="stats-toggle">
                        <button class="stats-btn active" onclick="showStats('total')">All Time</button>
                        <button class="stats-btn" onclick="showStats('ytd')">Year to Date</button>
                        <button class="stats-btn" onclick="showStats('month')">This Month</button>
                    </div>
                    <div id="bestCustomers" class="customers-container">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            Loading customer analytics...
                        </div>
                    </div>
                </div>

                <!-- Revenue Analytics -->
                <div class="dashboard-card animate-in">
                    <h3>💰 Revenue Analytics</h3>
                    <div id="revenueAnalytics" class="revenue-container">
                        <div class="revenue-item">
                            <span>Monthly Revenue:</span>
                            <span class="metric-value">CHF 12,450</span>
                        </div>
                        <div class="revenue-item">
                            <span>YTD Revenue:</span>
                            <span class="metric-value">CHF 78,230</span>
                        </div>
                        <div class="revenue-item">
                            <span>Average Booking:</span>
                            <span class="metric-value">CHF 185</span>
                        </div>
                    </div>
                </div>

                <!-- Van Utilization -->
                <div class="dashboard-card animate-in">
                    <h3>🚐 Van Utilization</h3>
                    <div id="vanUtilization" class="utilization-container">
                        <div class="utilization-item" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-size: 12px;">N01 - Opel Vivaro</span>
                                <span style="font-weight: 600;">85%</span>
                            </div>
                            <div class="utilization-bar">
                                <div class="utilization-fill" style="width: 85%;"></div>
                            </div>
                        </div>
                        <div class="utilization-item" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-size: 12px;">N03 - Peugeot Boxer</span>
                                <span style="font-weight: 600;">72%</span>
                            </div>
                            <div class="utilization-bar">
                                <div class="utilization-fill" style="width: 72%;"></div>
                            </div>
                        </div>
                        <div class="utilization-item">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-size: 12px;">N04 - Fiat Ducato</span>
                                <span style="font-weight: 600;">91%</span>
                            </div>
                            <div class="utilization-bar">
                                <div class="utilization-fill" style="width: 91%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="dashboard-card animate-in">
                    <h3>⚡ Quick Actions</h3>
                    <div class="quick-actions">
                        <button class="action-btn" onclick="buildCRMDatabase()">
                            📊 Build CRM Database
                        </button>
                        <button class="action-btn" onclick="exportCustomerList()">
                            📋 Export Customer List
                        </button>
                        <button class="action-btn" onclick="generateReports()">
                            📈 Generate Reports
                        </button>
                        <button class="action-btn" onclick="openCrmSpreadsheet()">
                            📄 Open CRM Spreadsheet
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>    <script>
        // Configuration
        const CALENDAR_IDS = [
            'noleggiosemplice23@gmail.com',
            'nijfu8k23bns6ml5rb0f7hko5o@group.calendar.google.com',
            'e48a242e31251e913222eec57efddba56d45e1efaa8346a95aa4c001699f4f5d@group.calendar.google.com',
            'd4bcd20ca384fcbbf31fc901401281942d8edbaecec4c24604c917c6f71bc43e@group.calendar.google.com',
            '8c2a425fa75bf5230dd2eee2a5cbedfcfa01279e943b5817efa25dfb359d8920@group.calendar.google.com',
            'aa19b3fbefcdee63ffa1b724e3a2f4c65ed49949db2e6cf3d40e13924daea94b@group.calendar.google.com',
            '6e36e87a89e5ef58137cf3c2475226dbb5c5a8aec3a60bce80e63fc72552f4b5@group.calendar.google.com',
            '9535c25ccd3adc5dc5a908aa9055cd8893e547657d6257f0a0232d50214c8c99@group.calendar.google.com',
            'a97fc8429fc9a143475e0244ad922ce0f6dfb025a88dd68baadd116ef4f0b5cc@group.calendar.google.com',
            '0e9a455f793914439c9ae0e5ef91790038aa8fc295e71cfacbc3b8f128def8fa@group.calendar.google.com'
        ];

        // Fallback calendar names
        const CALENDAR_NAMES = [
            'Main Calendar',
            'N01 - Opel Vivaro (Losone)',
            'N03 - Peugeot Boxer (Bellinzona)',
            'N04 - Fiat Ducato (Locarno)',
            'N06 - Citroen Jumper (Minusio)',
            'N07 - Renault Trafic (Lugano)',
            'N08 - Renault Trafic (Lugano)',
            'N09 - Renault Trafic (Bellinzona)',
            'N10 - Citroen Jumper (Losone)',
            'N11 - Citroen Jumper (Losone)'
        ];

        const vanColors = [
            '#667eea', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4',
            '#FECA57', '#FF9FF3', '#54A0FF', '#5F27CD', '#00D2D3'
        ];

        // Global variables
        let currentDate = new Date();
        let currentEvents = [];
        let selectedCalendars = new Set();
        let dynamicCalendarNames = [...CALENDAR_NAMES];
        let dynamicCalendarData = [];

        // JSONP helper function
        function makeJsonpRequest(url, timeout = 10000) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                const script = document.createElement('script');
                const timeoutId = setTimeout(() => {
                    cleanup();
                    reject(new Error('JSONP request timeout'));
                }, timeout);
                
                function cleanup() {
                    clearTimeout(timeoutId);
                    document.head.removeChild(script);
                    delete window[callbackName];
                }
                
                window[callbackName] = function(data) {
                    cleanup();
                    resolve(data);
                };
                
                script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + callbackName;
                script.onerror = () => {
                    cleanup();
                    reject(new Error('JSONP script load failed'));
                };
                
                document.head.appendChild(script);
            });
        }        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial tab state
            switchTab('calendar');
            
            // Initialize selected calendars
            initializeSelectedCalendars();
            
            // Load calendar names and data
            loadCalendarNames().then(() => {
                generateCalendar();
                loadCalendarData();
            });
        });

        function initializeSelectedCalendars() {
            selectedCalendars.clear();
            for (let i = 0; i < CALENDAR_NAMES.length; i++) {
                selectedCalendars.add(i);
            }
        }

        // Settings
        function getSettings() {
            // Correct script URL that is confirmed to work
            const defaultSettings = {
                scriptUrl: 'https://script.google.com/macros/s/AKfycbyoO-GlsISkbsD1kBWv0wnIXGKXja_VS0VVBei0aAikAJ2dIaCmjtj-1sGRRn1RCPN_/exec',
                authToken: 'myAppToken2025'
            };
           
            try {
                const savedSettings = localStorage.getItem('appSettings');
                
                // If no saved settings, use defaults
                if (!savedSettings) {
                    return defaultSettings;
                }
                
                // Parse saved settings
                const parsedSettings = JSON.parse(savedSettings);
                
                // Verify if stored URL is a known problematic URL
                // If so, ignore localStorage and use the default
                if (parsedSettings.scriptUrl && 
                    (parsedSettings.scriptUrl.includes('AKfycbxksJAHHqDZ7E2VTp3TazcC4SOCOWef2oM2Tz5MY5Px--A7TUqNjIXeUev5J1QW-T0b') || 
                     parsedSettings.scriptUrl !== defaultSettings.scriptUrl)) {
                    console.log('⚠️ Found outdated script URL in localStorage. Using correct default URL instead.');
                    // Update localStorage with correct URL
                    localStorage.setItem('appSettings', JSON.stringify(defaultSettings));
                    return defaultSettings;
                }
                
                // Merge with defaults and return
                return { ...defaultSettings, ...parsedSettings };
            } catch (error) {
                console.log('⚠️ localStorage not available or error occurred, using default settings:', error);
                return defaultSettings;
            }
        }

        // Load calendar names dynamically from Google Calendar
        async function loadCalendarNames() {
            // Check if we already loaded the names
            if (dynamicCalendarNames.length > 0 && dynamicCalendarNames !== CALENDAR_NAMES) {
                console.log('📅 Calendar names already loaded:', dynamicCalendarNames);
                return;
            }
            
            try {
                const settings = getSettings();
                
                // Check if settings are properly configured
                if (!settings.scriptUrl || !settings.authToken) {
                    console.warn('📅 Settings not configured properly, using static calendar names');
                    dynamicCalendarNames = [...CALENDAR_NAMES];
                    updateCalendarDropdown();
                    updateCalendarLegend();
                    updateCalendarSelector();
                    return;
                }
                
                console.log('📅 Loading calendar names from Google Calendar...');
                
                // Try JSONP method first (more reliable for Google Apps Script)
                const jsonpUrl = `${settings.scriptUrl}?function=getCalendarNamesAppJsonp&authToken=${settings.authToken}`;
                
                try {
                    const jsonpData = await makeJsonpRequest(jsonpUrl, 10000); // 10 second timeout
                    
                    if (jsonpData && jsonpData.success && jsonpData.result && Array.isArray(jsonpData.result)) {
                        dynamicCalendarNames = ['Main Calendar', ...jsonpData.result.slice(1)];
                        
                        // Check if we have calendar color data too
                        if (jsonpData.calendars && Array.isArray(jsonpData.calendars)) {
                            dynamicCalendarData = jsonpData.calendars;
                            console.log('📅 Successfully loaded calendar names and colors via JSONP:', dynamicCalendarNames);
                            console.log('🎨 Calendar colors:', jsonpData.calendars.map(cal => cal.color));
                        } else {
                            console.log('📅 Successfully loaded calendar names via JSONP (no color data):', dynamicCalendarNames);
                        }                        
                        updateCalendarDropdown();
                        updateCalendarLegend();
                        updateCalendarSelector();
                        return;
                    }
                } catch (jsonpError) {
                    console.warn('📅 JSONP method failed, trying fetch...', jsonpError);
                }
                
                // Fallback to fetch method
                const fetchUrl = `${settings.scriptUrl}?function=getCalendarNames&authToken=${settings.authToken}`;
                const response = await fetch(fetchUrl);
                const data = await response.json();
                
                if (data.result && Array.isArray(data.result)) {
                    dynamicCalendarNames = ['Main Calendar', ...data.result.slice(1)];
                    console.log('📅 Successfully loaded calendar names via fetch:', dynamicCalendarNames);
                    updateCalendarDropdown();
                    updateCalendarLegend();
                    updateCalendarSelector();
                } else {
                    throw new Error('Invalid response format from fetch');
                }
                
            } catch (error) {
                console.warn('📅 Could not load dynamic calendar names, using static fallback:', error);
                dynamicCalendarNames = [...CALENDAR_NAMES];
                updateCalendarDropdown();
                updateCalendarLegend();
                updateCalendarSelector();
            }
        }

        // Tab System
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`${tabName}-tab`);
            const selectedBtn = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            
            if (selectedTab) selectedTab.classList.add('active');
            if (selectedBtn) selectedBtn.classList.add('active');
            
            // Update dashboard data when switching to dashboard tab
            if (tabName === 'dashboard') {
                loadTodaySchedule();
                updateRevenueDashboard();
                updateUtilizationDashboard();
                loadBestCustomers('month');
            }
        }

        // Calendar Functions
        // Update calendar dropdown with dynamic names
        function updateCalendarDropdown() {
            const dropdown = document.getElementById('calendarFilter');
            if (!dropdown) return;
            
            // Clear existing options
            dropdown.innerHTML = '<option value="all">All Calendars</option>';
            
            // Add calendar options using dynamic names
            const namesToUse = dynamicCalendarNames.length > 0 ? dynamicCalendarNames : CALENDAR_NAMES;
            namesToUse.forEach((name, index) => {
                const option = document.createElement('option');
                option.value = index.toString();
                option.textContent = name;
                dropdown.appendChild(option);
            });
        }        // Update calendar legend with dynamic names and colors
        function updateCalendarLegend() {
            const legend = document.getElementById('vanLegend');
            if (!legend) return;
            
            legend.innerHTML = '';
            const namesToUse = dynamicCalendarNames.length > 0 ? dynamicCalendarNames : CALENDAR_NAMES;
            
            namesToUse.forEach((name, index) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                
                // Determine color
                let color = vanColors[index % vanColors.length];
                if (dynamicCalendarData.length > index && dynamicCalendarData[index].color) {
                    color = dynamicCalendarData[index].color;
                }
                
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${color}"></div>
                    <span class="legend-text">${name}</span>
                `;
                legend.appendChild(legendItem);
            });
        }

        // Update calendar selector with checkboxes
        function updateCalendarSelector() {
            const selector = document.querySelector('.calendar-selector');
            if (!selector) return;
            
            selector.innerHTML = '';
            const namesToUse = dynamicCalendarNames.length > 0 ? dynamicCalendarNames : CALENDAR_NAMES;
            
            namesToUse.forEach((name, index) => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'calendar-checkbox-item';
                
                // Determine color
                let color = vanColors[index % vanColors.length];
                if (dynamicCalendarData.length > index && dynamicCalendarData[index].color) {
                    color = dynamicCalendarData[index].color;
                }
                
                checkboxItem.innerHTML = `
                    <input type="checkbox" id="cal_${index}" ${selectedCalendars.has(index) ? 'checked' : ''} 
                           onchange="toggleCalendarSelection(${index})">
                    <div class="calendar-checkbox-color" style="background-color: ${color}"></div>
                    <label for="cal_${index}">${name}</label>
                `;
                
                selector.appendChild(checkboxItem);
            });
        }

        // Toggle calendar selection
        function toggleCalendarSelection(index) {
            if (selectedCalendars.has(index)) {
                selectedCalendars.delete(index);
            } else {
                selectedCalendars.add(index);
            }
            
            // Re-render events with updated selection
            renderEvents();
        }

        function generateCalendar() {
            const calendar = document.getElementById('calendarView');
            const monthYear = document.getElementById('currentMonthYear');
           
            // Update month/year display
            const options = { year: 'numeric', month: 'long' };
            monthYear.textContent = currentDate.toLocaleDateString('en-US', options);
           
            // Clear calendar
            calendar.innerHTML = '';
           
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
           
            // Get first day of month and number of days
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
           
            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
               
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
               
                // Add classes for styling
                if (date.getMonth() !== currentDate.getMonth()) {
                    dayElement.style.opacity = '0.5';
                }
               
                if (isToday(date)) {
                    dayElement.classList.add('today');
                }
               
                // Day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = date.getDate();
                dayElement.appendChild(dayNumber);
               
                // Events container
                const eventsContainer = document.createElement('div');
                eventsContainer.className = 'day-events';
                dayElement.appendChild(eventsContainer);
               
                calendar.appendChild(dayElement);
            }
           
            renderEvents();
        }        function renderEvents() {
            // Use actual events if available, otherwise use mock data
            const events = currentEvents.length > 0 ? currentEvents : generateMockEvents();
            
            const calendar = document.getElementById('calendarView');
            const days = calendar.querySelectorAll('.calendar-day');
            
            // Clear existing events
            days.forEach(day => {
                const eventsContainer = day.querySelector('.day-events');
                if (eventsContainer) {
                    eventsContainer.innerHTML = '';
                }
            });

            // Filter events based on selected calendars
            const filteredEvents = events.filter(event => {
                const calendarIndex = event.calendarIndex !== undefined ? event.calendarIndex : 0;
                return selectedCalendars.has(calendarIndex);
            });
            
            // Add events to calendar
            filteredEvents.forEach(event => {
                const eventDate = new Date(event.start.dateTime || event.start.date);
                const dayIndex = findDayIndex(eventDate);
                
                if (dayIndex >= 0 && dayIndex < days.length) {
                    const eventsContainer = days[dayIndex].querySelector('.day-events');
                    if (eventsContainer) {
                        const eventPill = document.createElement('div');
                        eventPill.className = `event-pill ${getEventColorClass(event)}`;
                        
                        // Truncate long event names
                        const eventTitle = event.summary || event.title || 'Untitled Event';
                        eventPill.textContent = eventTitle.length > 20 ? eventTitle.substring(0, 20) + '...' : eventTitle;
                        
                        // Create tooltip with event details
                        const calendarName = getCalendarDisplayName(event.calendarIndex || 0);
                        const timeInfo = getEventTimeInfo(event);
                        eventPill.title = `${eventTitle}\n${calendarName}\n${timeInfo}`;
                        
                        // Set event color based on calendar
                        const calendarIndex = event.calendarIndex || 0;
                        let color = vanColors[calendarIndex % vanColors.length];
                        if (dynamicCalendarData.length > calendarIndex && dynamicCalendarData[calendarIndex].color) {
                            color = dynamicCalendarData[calendarIndex].color;
                        }
                        eventPill.style.borderLeft = `3px solid ${color}`;
                        
                        eventPill.onclick = () => selectEvent(event);
                        eventsContainer.appendChild(eventPill);
                    }
                }
            });
            
            // Update dashboard if we're on the dashboard tab
            const dashboardTab = document.getElementById('dashboard-tab');
            if (dashboardTab && dashboardTab.classList.contains('active')) {
                loadTodaySchedule();
                updateRevenueDashboard();
                updateUtilizationDashboard();
            }
        }

        function getEventTimeInfo(event) {
            if (!event.start.dateTime || !event.end.dateTime) {
                return 'All day';
            }
            
            const startTime = new Date(event.start.dateTime);
            const endTime = new Date(event.end.dateTime);
            const startHour = startTime.getHours();
            const endHour = endTime.getHours();
            
            // Format times
            const startStr = startTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            const endStr = endTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            
            return `${startStr} - ${endStr}`;
        }

        function generateMockEvents() {
            const events = [];
            const customers = ['Marco Rossi', 'Anna Bianchi', 'Giuseppe Verde', 'Maria Neri', 'Luca Gialli'];
            const vans = ['N01', 'N03', 'N04', 'N06', 'N07'];
            
            for (let i = 0; i < 20; i++) {
                const randomDay = Math.floor(Math.random() * 30) + 1;
                const startHour = Math.random() > 0.5 ? 7 : 13; // Morning or afternoon
                const duration = Math.random() > 0.3 ? 5 : 12; // Half day or full day
                
                const startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), randomDay, startHour);
                const endDate = new Date(startDate);
                endDate.setHours(startDate.getHours() + duration);
                
                events.push({
                    id: `event_${i}`,
                    summary: `${customers[Math.floor(Math.random() * customers.length)]} - ${vans[Math.floor(Math.random() * vans.length)]}`,
                    start: { dateTime: startDate.toISOString() },
                    end: { dateTime: endDate.toISOString() },
                    calendarIndex: Math.floor(Math.random() * CALENDAR_NAMES.length),
                    location: 'Pickup Location',
                    description: 'Van rental booking'
                });
            }
            
            return events;
        }

        function getEventColorClass(event) {
            if (!event.start.dateTime || !event.end.dateTime) return 'default';
            
            const startTime = new Date(event.start.dateTime);
            const endTime = new Date(event.end.dateTime);
            const startHour = startTime.getHours();
            const endHour = endTime.getHours();
            
            // Full day: 7:00-19:00
            if (startHour === 7 && endHour === 19) return 'full-day';
            // Morning: 7:00-12:00
            if (startHour === 7 && endHour === 12) return 'morning';
            // Afternoon: 13:00-19:00
            if (startHour === 13 && endHour === 19) return 'afternoon';
            
            return 'default';
        }

        function findDayIndex(date) {
            const calendar = document.getElementById('calendarView');
            const days = calendar.querySelectorAll('.calendar-day');
           
            for (let i = 7; i < days.length; i++) { // Skip header row
                const dayNumber = days[i].querySelector('.day-number');
                const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                dayDate.setDate(dayDate.getDate() - new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay() + i - 7);
               
                if (dayDate.toDateString() === date.toDateString()) {
                    return i;
                }
            }
            return -1;
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function getCalendarDisplayName(calendarIndex) {
            return dynamicCalendarNames[calendarIndex] || `Calendar ${calendarIndex}`;
        }

        function selectEvent(event) {
            console.log('Selected event:', event);
            // Here you could show event details in a modal or sidebar
            alert(`Event: ${event.summary || event.title}\nCalendar: ${getCalendarDisplayName(event.calendarIndex || 0)}\nTime: ${getEventTimeInfo(event)}`);
        }

        function refreshCalendar() {
            console.log('🔄 Refreshing calendar...');
            loadCalendarData();
        }

        function changeDate(direction) {
            if (direction === 'prev') {
                currentDate.setMonth(currentDate.getMonth() - 1);
            } else {
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            generateCalendar();
            loadCalendarData();
        }
        
        function navigateMonth(direction) {
            if (direction === -1) {
                currentDate.setMonth(currentDate.getMonth() - 1);
            } else {
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            generateCalendar();
            loadCalendarData();
        }

        function goToToday() {
            currentDate = new Date();
            generateCalendar();
            loadCalendarData();
        }        // Load calendar data from Google Calendar
        async function loadCalendarData() {
            if (isLoading) {
                console.log('📅 Calendar data is already loading...');
                return;
            }
            
            isLoading = true;
            setLoadingState(true);
            
            try {
                const settings = getSettings();
                
                if (!settings.scriptUrl || !settings.authToken) {
                    console.warn('📅 Settings not configured, using mock data');
                    currentEvents = generateMockEvents();
                    renderEvents();
                    return;
                }

                console.log('📅 Loading calendar data...');
                
                // Create date range for the current month
                const start = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const end = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                
                const params = new URLSearchParams({
                    function: 'getCalendarEvents',
                    authToken: settings.authToken,
                    startDate: start.toISOString().split('T')[0],
                    endDate: end.toISOString().split('T')[0]
                });

                const response = await fetch(`${settings.scriptUrl}?${params}`);
                const data = await response.json();
                
                if (data.events && Array.isArray(data.events)) {
                    currentEvents = data.events;
                    console.log('📅 Successfully loaded calendar events:', data.events.length);
                    renderEvents();
                } else {
                    console.warn('📅 No events data in response, using mock data');
                    currentEvents = generateMockEvents();
                    renderEvents();
                }
                
            } catch (error) {
                console.warn('📅 Failed to load calendar data, using mock data:', error);
                currentEvents = generateMockEvents();
                renderEvents();
            } finally {
                isLoading = false;
                setLoadingState(false);
            }
        }

        // Add loading state management
        function setLoadingState(isLoading) {
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshIcon = document.getElementById('refreshIcon');
            
            if (refreshBtn && refreshIcon) {
                if (isLoading) {
                    refreshBtn.disabled = true;
                    refreshIcon.textContent = '⏳';
                    refreshBtn.style.opacity = '0.7';
                } else {
                    refreshBtn.disabled = false;
                    refreshIcon.textContent = '🔄';
                    refreshBtn.style.opacity = '1';
                }
            }
        }

        // Dashboard Functions
        function loadDashboardData() {
            loadTodaySchedule();
            loadCustomerRatings();
            loadBestCustomers('total');
        }

        function loadTodaySchedule() {
            const scheduleContainer = document.getElementById('todaySchedule');
            if (!scheduleContainer) return;
            
            const today = new Date();
            const todayEvents = currentEvents.filter(event => {
                const eventDate = new Date(event.start.dateTime || event.start.date);
                return eventDate.toDateString() === today.toDateString();
            });
            
            if (todayEvents.length === 0) {
                scheduleContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px;">
                        <p>📅 No bookings scheduled for today</p>
                    </div>
                `;
                return;
            }
            
            // Sort events by time
            todayEvents.sort((a, b) => {
                const timeA = new Date(a.start.dateTime || a.start.date);
                const timeB = new Date(b.start.dateTime || b.start.date);
                return timeA - timeB;
            });
            
            let scheduleHTML = '';
            todayEvents.forEach(event => {
                const calendarName = getCalendarDisplayName(event.calendarIndex || 0);
                const timeInfo = getEventTimeInfo(event);
                const eventTitle = event.summary || event.title || 'Untitled Event';
                
                scheduleHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f2f5;">
                        <div>
                            <div style="font-weight: 500;">${eventTitle}</div>
                            <div style="font-size: 11px; color: #666;">${calendarName}</div>
                        </div>
                        <div style="text-align: right; font-size: 12px; color: #333;">
                            ${timeInfo}
                        </div>
                    </div>
                `;
            });
            
            scheduleContainer.innerHTML = scheduleHTML;
        }

        function updateRevenueDashboard() {
            const revenueContainer = document.getElementById('revenueMetrics');
            if (!revenueContainer) return;
            
            // Calculate mock revenue based on events
            const totalBookings = currentEvents.length;
            const avgBookingValue = 250; // Average booking value in CHF
            const monthlyRevenue = totalBookings * avgBookingValue;
            const weeklyRevenue = Math.round(monthlyRevenue * 0.25);
            const dailyRevenue = Math.round(monthlyRevenue / 30);
            
            revenueContainer.innerHTML = `
                <div class="revenue-item">
                    <span>Daily Revenue</span>
                    <span class="metric-value">CHF ${dailyRevenue}</span>
                </div>
                <div class="revenue-item">
                    <span>Weekly Revenue</span>
                    <span class="metric-value">CHF ${weeklyRevenue}</span>
                </div>
                <div class="revenue-item">
                    <span>Monthly Revenue</span>
                    <span class="metric-value">CHF ${monthlyRevenue}</span>
                </div>
                <div class="revenue-item">
                    <span>Total Bookings</span>
                    <span class="metric-value">${totalBookings}</span>
                </div>
            `;
        }

        function updateUtilizationDashboard() {
            const utilizationContainer = document.getElementById('utilizationMetrics');
            if (!utilizationContainer) return;
            
            const namesToUse = dynamicCalendarNames.length > 0 ? dynamicCalendarNames : CALENDAR_NAMES;
            let utilizationHTML = '';
            
            namesToUse.forEach((name, index) => {
                if (index === 0) return; // Skip main calendar
                
                // Calculate utilization based on events for this van
                const vanEvents = currentEvents.filter(event => event.calendarIndex === index);
                const utilizationPercent = Math.min(100, Math.round((vanEvents.length / 20) * 100)); // Max 20 bookings per month
                
                utilizationHTML += `
                    <div class="utilization-item">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-size: 12px;">${name}</span>
                            <span style="font-size: 12px; font-weight: 600;">${utilizationPercent}%</span>
                        </div>
                        <div class="utilization-bar">
                            <div style="width: ${utilizationPercent}%; height: 100%; background: linear-gradient(90deg, #4CAF50, #81C784); border-radius: 4px;"></div>
                        </div>
                    </div>
                `;
            });
            
            utilizationContainer.innerHTML = utilizationHTML;
        }

        function loadCustomerRatings() {
            const ratingsContainer = document.getElementById('customerRatings');
            
            const mockRatings = [
                { name: 'Marco Rossi', rating: 5, rentals: 8 },
                { name: 'Anna Bianchi', rating: 5, rentals: 12 },
                { name: 'Giuseppe Verde', rating: 4, rentals: 5 },
                { name: 'Maria Neri', rating: 5, rentals: 15 }
            ];

            let ratingsHTML = '';
            mockRatings.forEach(customer => {
                const stars = '★'.repeat(customer.rating) + '☆'.repeat(5 - customer.rating);
                ratingsHTML += `
                    <div class="customer-rating">
                        <div>
                            <div style="font-weight: 500;">${customer.name}</div>
                            <div style="font-size: 11px; color: #666;">${customer.rentals} rentals</div>
                        </div>
                        <div class="rating-stars">${stars}</div>
                    </div>
                `;
            });

            ratingsContainer.innerHTML = ratingsHTML;
        }

        function loadBestCustomers(period) {
            // Update active button
            document.querySelectorAll('.stats-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="showStats('${period}')"]`).classList.add('active');

            const customersContainer = document.getElementById('bestCustomers');
            
            let customers = [];
            switch(period) {
                case 'total':
                    customers = [
                        { name: 'Maria Neri', revenue: 'CHF 2,850', rentals: 15 },
                        { name: 'Anna Bianchi', revenue: 'CHF 2,220', rentals: 12 },
                        { name: 'Franco Blu', revenue: 'CHF 1,980', rentals: 11 }
                    ];
                    break;
                case 'ytd':
                    customers = [
                        { name: 'Anna Bianchi', revenue: 'CHF 1,850', rentals: 10 },
                        { name: 'Maria Neri', revenue: 'CHF 1,650', rentals: 9 },
                        { name: 'Franco Blu', revenue: 'CHF 1,350', rentals: 7 }
                    ];
                    break;
                case 'month':
                    customers = [
                        { name: 'Marco Rossi', revenue: 'CHF 555', rentals: 3 },
                        { name: 'Anna Bianchi', revenue: 'CHF 370', rentals: 2 }
                    ];
                    break;
            }

            let customersHTML = '';
            customers.forEach((customer, index) => {
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '👤';
                customersHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f2f5;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>${medal}</span>
                            <div>
                                <div style="font-weight: 500;">${customer.name}</div>
                                <div style="font-size: 11px; color: #666;">${customer.rentals} rentals</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: #2e7d32;">${customer.revenue}</div>
                        </div>
                    </div>
                `;
            });

            customersContainer.innerHTML = customersHTML;
        }

        function showStats(period) {
            loadBestCustomers(period);
        }

        // CRM Actions
        function buildCRMDatabase() {
            alert('Building CRM Database... This will analyze all calendar events and create customer profiles.');
        }

        function exportCustomerList() {
            alert('Exporting customer list... This will create a CSV file with all customer data.');
        }

        function generateReports() {
            alert('Generating reports... This will create monthly and annual reports.');
        }

        function openCrmSpreadsheet() {
            alert('Opening CRM Spreadsheet... This will open the Google Sheets with customer data.');
        }

        // Calendar filter
        document.getElementById('calendarFilter').addEventListener('change', function() {
            renderEvents();
        });
    </script>
</body>
</html>
